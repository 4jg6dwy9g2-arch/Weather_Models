{% extends "base.html" %}

{% block title %}Current Conditions - Weather Forecast{% endblock %}

{% block extra_css %}
<style>
    .current-hero {
        background: #2f6b86;
        color: #f7fbff;
        border-radius: 16px;
        padding: 28px 32px;
        margin-bottom: 20px;
        position: relative;
        overflow: hidden;
    }

    .current-hero::after {
        content: "";
        position: absolute;
        right: -120px;
        top: -80px;
        width: 320px;
        height: 320px;
        background: radial-gradient(circle, rgba(255,255,255,0.18), rgba(255,255,255,0));
        border-radius: 50%;
    }

    .current-hero h1 {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 6px;
    }

    .current-hero .hero-meta {
        font-size: 1rem;
        opacity: 0.85;
        margin-bottom: 16px;
    }

    .hero-location {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
        font-size: 1.05rem;
    }

    .hero-location-inline {
        display: inline-block;
        font-weight: 600;
        font-size: inherit;
        color: rgba(248, 250, 252, 0.9);
    }

    .current-hero h1 {
        color: #ffffff;
    }

    .hero-main {
        display: grid;
        grid-template-columns: max-content 200px 240px;
        column-gap: 56px;
        row-gap: 20px;
        align-items: start;
    }

    .hero-primary {
        max-width: 360px;
    }

    .hero-almanac {
        justify-self: start;
        margin-left: 40px;
    }

    .hero-condition-block {
        text-align: center;
        margin-bottom: 12px;
    }

    .hero-temp {
        margin-top: 32px;
    }

    .hero-condition-block .hero-icon {
        width: 90px;
        height: 90px;
        margin: 0 auto;
    }

    .hero-condition-block .hero-icon i {
        font-size: 2.5rem;
    }

    .hero-temp {
        font-size: 5.5rem;
        font-weight: 700;
        line-height: 1;
        margin: 0;
        display: flex;
        align-items: flex-end;
        gap: 12px;
    }

    .hero-dewpoint {
        font-size: 1.7rem;
        font-weight: 600;
        opacity: 0.85;
        margin-bottom: 12px;
    }

    .hero-indoor {
        margin-top: 12px;
        font-size: 1.05rem;
        opacity: 0.9;
    }

    .hero-indoor span {
        margin-right: 18px;
        display: inline-block;
        font-weight: 600;
    }

    .hero-sub {
        font-size: 1.15rem;
        margin-top: 8px;
    }

    .hero-sub span {
        margin-right: 20px;
        display: inline-block;
    }

    .hero-kpis {
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
    }

    .hero-kpis {
        justify-self: start;
        margin-left: -8px;
    }

    .hero-kpi {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .hero-kpi.small {
        min-width: 170px;
    }

    .hero-icon {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        background: #2f93dd;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 0 0 10px rgba(255,255,255,0.1);
    }

    .hero-icon i {
        font-size: 4rem;
        color: #ffffff;
    }

    .hero-condition {
        text-align: center;
        font-size: 1.15rem;
        font-weight: 600;
        margin-top: 12px;
    }

    .hero-almanac {
        display: grid;
        gap: 10px;
        font-size: 0.95rem;
        background: rgba(255, 255, 255, 0.12);
        padding: 12px 14px;
        border-radius: 12px;
        min-width: 240px;
    }

    .almanac-title {
        font-size: 0.95rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: rgba(248, 250, 252, 0.9);
        margin-bottom: 2px;
    }

    .almanac-item {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        color: #f8fafc;
        font-weight: 600;
    }

    .almanac-item span {
        color: rgba(248, 250, 252, 0.8);
        font-weight: 500;
    }

    .details-card {
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        margin-bottom: 18px;
    }

    .details-card .card-header {
        background: #ffffff;
        border-bottom: 1px solid #eceff3;
        font-size: 0.95rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #4b5563;
    }

    .details-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px 24px;
        padding: 18px 22px 24px;
        background: #f7f7f8;
    }

    .detail-item {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-size: 1rem;
        color: #374151;
    }

    .detail-item span:last-child {
        font-weight: 600;
        color: #111827;
    }

    .aqi-card {
        border-radius: 16px;
        border: 1px solid #e5e7eb;
        background: #ffffff;
        padding: 18px 22px;
        display: grid;
        grid-template-columns: 80px 1fr;
        gap: 16px;
        align-items: center;
        margin-bottom: 18px;
    }

    .aqi-icon {
        width: 72px;
        height: 72px;
        min-width: 72px;
        min-height: 72px;
        aspect-ratio: 1 / 1;
        flex: 0 0 72px;
        border-radius: 50%;
        background: #7bc043;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #ffffff;
        font-size: 2rem;
        overflow: hidden;
    }

    .aqi-value {
        font-size: 1.5rem;
        font-weight: 700;
    }

    .aqi-value-row {
        display: flex;
        align-items: baseline;
        gap: 12px;
        flex-wrap: wrap;
    }

    .pm25-inline {
        color: #ffffff;
        font-weight: 600;
        font-size: 1.05rem;
    }

    .aqi-sub {
        color: #111827;
    }

    .soil-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 14px 20px;
        padding: 18px 22px 24px;
    }

    .soil-item {
        background: #f7f7f8;
        border-radius: 12px;
        padding: 12px 14px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .soil-item strong {
        color: #111827;
    }

    .soil-schematic {
        width: 100%;
        height: auto;
        max-height: 560px;
        display: block;
    }

    .refresh-btn {
        cursor: pointer;
        transition: transform 0.3s;
    }
    .refresh-btn:hover {
        transform: rotate(180deg);
    }
    .refresh-btn.spinning {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    @media (max-width: 768px) {
        .hero-main {
            grid-template-columns: 1fr;
            text-align: left;
        }
        .hero-icon {
            width: 110px;
            height: 110px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="current-hero">
    <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
        <div>
            <h1>Today's Weather: <span class="hero-location-inline" id="locationName">Fairfax, VA</span></h1>
            <div class="hero-meta" id="lastUpdate">As of --</div>
        </div>
        <div class="text-end">
            <i class="bi bi-arrow-clockwise refresh-btn text-white fs-4" id="refreshBtn" onclick="loadCurrentWeather()" title="Refresh"></i>
        </div>
    </div>

    <div class="hero-main">
        <div class="hero-primary">
            <div class="hero-condition-block">
                <div class="hero-icon"><i class="bi bi-cloud-sun" id="conditionIcon"></i></div>
                <div class="hero-condition" id="conditionLabel">Current Conditions</div>
            </div>
            <div class="hero-temp">
                <span id="currentTemp">--°</span>
                <span class="hero-dewpoint" id="dewpointInline">/ --°</span>
            </div>
            <div class="hero-sub">
                <span>Feels like: <strong id="feelsLike">--°F</strong></span>
                <span>Hi: <strong id="tempHigh">--°F</strong></span>
                <span>Lo: <strong id="tempLow">--°F</strong></span>
            </div>
            <div class="hero-indoor">
                <span>Indoor: <strong id="indoorTempHero">--°F</strong></span>
                <span>Humidity: <strong id="indoorHumHero">--%</strong></span>
            </div>
        </div>
        <div class="hero-kpis">
            <div class="hero-kpi">
                <div class="aqi-icon" id="aqiIcon"><i class="bi bi-wind"></i></div>
                <div>
                    <div class="aqi-value-row">
                        <div class="aqi-value" id="aqiValue">--</div>
                        <div class="pm25-inline" id="pm25Value">PM2.5 -- µg/m³</div>
                    </div>
                    <div class="aqi-sub" id="aqiCategory">Air Quality</div>
                </div>
            </div>
            <div class="hero-kpi">
                <div class="aqi-icon" style="background:#ffd166;"><i class="bi bi-sun"></i></div>
                <div>
                    <div class="aqi-value" id="solarRad">--</div>
                    <div class="aqi-sub">Solar Radiation</div>
                </div>
            </div>
            <div class="hero-kpi small">
                <div class="aqi-icon" style="background:#8b9cf6;"><i class="bi bi-speedometer2"></i></div>
                <div>
                    <div class="aqi-value" id="pressure">--</div>
                    <div class="aqi-sub">Pressure</div>
                </div>
            </div>
            <div class="hero-kpi small">
                <div class="aqi-icon" style="background:#38bdf8;"><i class="bi bi-wind"></i></div>
                <div>
                    <div class="aqi-value" id="windGust">--</div>
                    <div class="aqi-sub">Wind Gust</div>
                </div>
            </div>
            <div class="hero-kpi small">
                <div class="aqi-icon" style="background:#0ea5e9;"><i class="bi bi-droplet-half"></i></div>
                <div>
                    <div class="aqi-value" id="rain24">--</div>
                    <div class="aqi-sub">Rain (24h)</div>
                </div>
            </div>
        </div>
        <div class="hero-almanac">
            <div class="almanac-title">Almanac</div>
            <div class="almanac-item"><span>Sunrise</span><strong id="almanacSunrise">--</strong></div>
            <div class="almanac-item"><span>Sunset</span><strong id="almanacSunset">--</strong></div>
            <div class="almanac-item"><span>Normal High</span><strong id="almanacNormalHigh">--</strong></div>
            <div class="almanac-item"><span>Normal Low</span><strong id="almanacNormalLow">--</strong></div>
            <div class="almanac-item"><span>Moonrise</span><strong id="almanacMoonrise">--</strong></div>
            <div class="almanac-item"><span>Moonset</span><strong id="almanacMoonset">--</strong></div>
            <div class="almanac-item"><span>Moon Phase</span><strong id="almanacMoonPhase">--</strong></div>
        </div>
    </div>
</div>

<div id="loadingState" class="loading-spinner">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Loading current conditions...</p>
    </div>
</div>

<div id="errorState" class="alert alert-danger d-none">
    <i class="bi bi-exclamation-triangle"></i>
    <span id="errorMessage">Failed to load weather data.</span>
</div>

<div id="weatherContent" class="d-none">
    <div class="details-card">
        <div class="card-header">Soil Profile</div>
        <div class="card-body p-0">
            <svg class="soil-schematic" viewBox="0 0 800 480">
                <defs>
                    <linearGradient id="skyGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b7fa1;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#5c9fbf;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="soilGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#7a5c4b;stop-opacity:1" />
                        <stop offset="60%" style="stop-color:#5b4336;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#4a362b;stop-opacity:1" />
                    </linearGradient>
                </defs>

                <rect x="0" y="0" width="800" height="80" fill="url(#skyGradient)" />
                <rect x="0" y="80" width="800" height="400" fill="url(#soilGradient)" />

                <g font-size="16" fill="#f8fafc" font-weight="600">
                    <text x="15" y="120" fill="#e2e8f0">Surface</text>
                    <line x1="0" y1="200" x2="60" y2="200" stroke="#f8fafc" stroke-width="1" stroke-dasharray="4,2" opacity="0.5" />
                    <text x="15" y="205">5 in</text>
                    <line x1="0" y1="320" x2="60" y2="320" stroke="#f8fafc" stroke-width="1" stroke-dasharray="4,2" opacity="0.5" />
                    <text x="15" y="325">10 in</text>
                    <line x1="0" y1="440" x2="60" y2="440" stroke="#f8fafc" stroke-width="1" stroke-dasharray="4,2" opacity="0.5" />
                    <text x="15" y="445">20 in</text>
                </g>

                <g transform="translate(220, 200)">
                    <rect x="-55" y="-18" width="110" height="36" rx="6" fill="rgba(255,255,255,0.92)" stroke="#8b6f52" stroke-width="2" />
                    <text x="0" y="7" font-size="18" fill="#8b6f52" font-weight="700" text-anchor="middle" id="schematic-soil-temp-5">--</text>
                </g>
                <g transform="translate(220, 320)">
                    <rect x="-55" y="-18" width="110" height="36" rx="6" fill="rgba(255,255,255,0.92)" stroke="#8b6f52" stroke-width="2" />
                    <text x="0" y="7" font-size="18" fill="#8b6f52" font-weight="700" text-anchor="middle" id="schematic-soil-temp-10">--</text>
                </g>
                <g transform="translate(220, 440)">
                    <rect x="-55" y="-18" width="110" height="36" rx="6" fill="rgba(255,255,255,0.92)" stroke="#8b6f52" stroke-width="2" />
                    <text x="0" y="7" font-size="18" fill="#8b6f52" font-weight="700" text-anchor="middle" id="schematic-soil-temp-20">--</text>
                </g>

                <g transform="translate(470, 200)">
                    <rect x="-55" y="-22" width="110" height="44" rx="6" fill="rgba(255,255,255,0.92)" stroke="#1f77b4" stroke-width="2" id="schematic-soil-moisture-5-rect" />
                    <text x="0" y="2" font-size="18" fill="#1f77b4" font-weight="700" text-anchor="middle" id="schematic-soil-moisture-5">--</text>
                    <text x="0" y="18" font-size="11" fill="#6b7280" text-anchor="middle" id="schematic-soil-moisture-5-pct">--</text>
                </g>
                <g transform="translate(470, 320)">
                    <rect x="-55" y="-22" width="110" height="44" rx="6" fill="rgba(255,255,255,0.92)" stroke="#1f77b4" stroke-width="2" id="schematic-soil-moisture-10-rect" />
                    <text x="0" y="2" font-size="18" fill="#1f77b4" font-weight="700" text-anchor="middle" id="schematic-soil-moisture-10">--</text>
                    <text x="0" y="18" font-size="11" fill="#6b7280" text-anchor="middle" id="schematic-soil-moisture-10-pct">--</text>
                </g>
                <g transform="translate(470, 440)">
                    <rect x="-55" y="-22" width="110" height="44" rx="6" fill="rgba(255,255,255,0.92)" stroke="#1f77b4" stroke-width="2" id="schematic-soil-moisture-20-rect" />
                    <text x="0" y="2" font-size="18" fill="#1f77b4" font-weight="700" text-anchor="middle" id="schematic-soil-moisture-20">--</text>
                    <text x="0" y="18" font-size="11" fill="#6b7280" text-anchor="middle" id="schematic-soil-moisture-20-pct">--</text>
                </g>

                <g transform="translate(610, 170)">
                    <rect x="0" y="0" width="170" height="130" rx="8" fill="rgba(255,255,255,0.95)" stroke="#d1d5db" />
                    <text x="85" y="20" font-size="12" fill="#4b5563" font-weight="600" text-anchor="middle">Soil moisture:</text>
                    <g transform="translate(10, 32)">
                        <rect x="0" y="0" width="12" height="12" fill="#1976d2" rx="2" />
                        <text x="18" y="10" font-size="11" fill="#333">0-10 cb: Saturated</text>
                    </g>
                    <g transform="translate(10, 52)">
                        <rect x="0" y="0" width="12" height="12" fill="#4caf50" rx="2" />
                        <text x="18" y="10" font-size="11" fill="#333">10-30 cb: Adequate</text>
                    </g>
                    <g transform="translate(10, 72)">
                        <rect x="0" y="0" width="12" height="12" fill="#ff9800" rx="2" />
                        <text x="18" y="10" font-size="11" fill="#333">30-60 cb: Dry</text>
                    </g>
                    <g transform="translate(10, 92)">
                        <rect x="0" y="0" width="12" height="12" fill="#f44336" rx="2" />
                        <text x="18" y="10" font-size="11" fill="#333">60+ cb: Very Dry</text>
                    </g>
                </g>
            </svg>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function formatValue(value, decimals = 0, suffix = '') {
    if (value === null || value === undefined) return '--';
    return value.toFixed(decimals) + suffix;
}

function setText(id, value) {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
}

function setHTML(id, value) {
    const el = document.getElementById(id);
    if (el) el.innerHTML = value;
}

function parseTimeToToday(timeStr) {
    if (!timeStr || timeStr === '--') return null;
    const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
    if (!match) return null;
    let hours = parseInt(match[1], 10);
    const minutes = parseInt(match[2], 10);
    const meridian = match[3].toUpperCase();
    if (meridian === 'PM' && hours !== 12) hours += 12;
    if (meridian === 'AM' && hours === 12) hours = 0;
    const dt = new Date();
    dt.setHours(hours, minutes, 0, 0);
    return dt;
}

async function loadCurrentWeather() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.classList.add('spinning');

    document.getElementById('loadingState').classList.remove('d-none');
    document.getElementById('weatherContent').classList.add('d-none');
    document.getElementById('errorState').classList.add('d-none');

    try {
        const response = await fetch('/api/current-weather');
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'Failed to load weather data');
        }

        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('weatherContent').classList.remove('d-none');

        const weather = data.weather;
        const location = data.location ? data.location.name : 'Fairfax, VA';

        const timeLabel = weather.timestamp_formatted ? `As of ${weather.timestamp_formatted}` : 'As of --';
        setText('lastUpdate', timeLabel);
        setText('locationName', location);

        const temp = weather.temp_f;
        setText('currentTemp', temp === null || temp === undefined ? '--°' : `${Math.round(temp)}°`);

        const feels = weather.heat_index_f ?? weather.temp_f;
        setText('feelsLike', feels === null || feels === undefined ? '--°F' : `${Math.round(feels)}°F`);
        const high = weather.temp_high_f;
        const low = weather.temp_low_f;
        setText('tempHigh', high === null || high === undefined ? '--°F' : `${Math.round(high)}°F`);
        setText('tempLow', low === null || low === undefined ? '--°F' : `${Math.round(low)}°F`);

        const iconEl = document.getElementById('conditionIcon');
        const almanac = data.almanac || {};
        const solarHist = almanac.solar_historical_avg;
        const solarNow = weather.solar_rad;
        const raining = weather.rain_rate_in !== null && weather.rain_rate_in !== undefined && Number(weather.rain_rate_in) > 0;

        let conditionLabel = data.is_daylight ? 'Daylight Conditions' : 'Nighttime Conditions';
        if (raining) {
            conditionLabel = 'Rain';
            if (iconEl) iconEl.className = 'bi bi-cloud-rain';
        } else if (data.is_daylight && solarNow !== null && solarNow !== undefined) {
            const sunrise = parseTimeToToday(almanac.sunrise);
            const sunset = parseTimeToToday(almanac.sunset);
            const now = new Date();
            let nearEdge = false;
            if (sunrise && sunset) {
                const minsToSunrise = Math.abs((now - sunrise) / 60000);
                const minsToSunset = Math.abs((sunset - now) / 60000);
                nearEdge = Math.min(minsToSunrise, minsToSunset) <= 90;
            }
            let threshold = 80;
            if (solarHist !== null && solarHist !== undefined) {
                threshold = nearEdge ? Math.max(15, solarHist * 0.2) : solarHist * 0.6;
            } else if (nearEdge) {
                threshold = 15;
            }
            if (solarNow >= threshold) {
                conditionLabel = 'Sunny';
                if (iconEl) iconEl.className = 'bi bi-sun';
            } else {
                conditionLabel = 'Cloudy';
                if (iconEl) iconEl.className = 'bi bi-cloud';
            }
        } else if (iconEl) {
            iconEl.className = data.is_daylight ? 'bi bi-cloud-sun' : 'bi bi-moon-stars';
        }
        setText('conditionLabel', conditionLabel);

        const dew = weather.dew_point_f;
        const dewLabel = dew === null || dew === undefined ? '--°' : `${Math.round(dew)}°`;
        setText('dewpointInline', `/ ${dewLabel}`);

        setText('aqiValue', weather.aqi !== null && weather.aqi !== undefined ? `${Math.round(weather.aqi)} | ${data.aqi_category || 'Unknown'}` : '--');
        setText('aqiCategory', data.aqi_category ? 'Air Quality' : 'Air quality unavailable');
        setText('pm25Value', weather.pm25 !== null && weather.pm25 !== undefined ? `PM2.5 ${Number(weather.pm25).toFixed(1)} µg/m³` : 'PM2.5 -- µg/m³');
        setText('solarRad', weather.solar_rad !== null && weather.solar_rad !== undefined ? `${Math.round(weather.solar_rad)} W/m²` : '--');
        setText('pressure', weather.barometer_mb !== null && weather.barometer_mb !== undefined ? `${Number(weather.barometer_mb).toFixed(1)} mb` : '--');
        setText('windGust', weather.wind_gust_mph !== null && weather.wind_gust_mph !== undefined ? `${Math.round(weather.wind_gust_mph)} mph` : '--');
        setText('rain24', weather.rain_24h_in !== null && weather.rain_24h_in !== undefined ? `${Number(weather.rain_24h_in).toFixed(2)} in` : '--');
        const aqiIcon = document.getElementById('aqiIcon');
        if (aqiIcon) {
            aqiIcon.style.background = data.aqi_color || '#7bc043';
        }

        setText('indoorTempHero', weather.inside_temp_f === null || weather.inside_temp_f === undefined
            ? '--°F' : `${Math.round(weather.inside_temp_f)}°F`);
        setText('indoorHumHero', weather.inside_humidity === null || weather.inside_humidity === undefined
            ? '--%' : `${Math.round(weather.inside_humidity)}%`);

        setText('almanacSunrise', almanac.sunrise || '--');
        setText('almanacSunset', almanac.sunset || '--');
        setText('almanacNormalHigh', almanac.normal_high !== null && almanac.normal_high !== undefined ? `${Math.round(almanac.normal_high)}°F` : '--');
        setText('almanacNormalLow', almanac.normal_low !== null && almanac.normal_low !== undefined ? `${Math.round(almanac.normal_low)}°F` : '--');
        setText('almanacMoonrise', almanac.moonrise || '--');
        setText('almanacMoonset', almanac.moonset || '--');
        setText('almanacMoonPhase', almanac.moon_phase || '--');

        const fmtSoil = (val) => (val === null || val === undefined) ? '--' : `${Number(val).toFixed(1)}°`;
        const getMoistureColor = (val) => {
            if (val === null || val === undefined || val <= 10) return '#1976d2';
            if (val <= 30) return '#4caf50';
            if (val <= 60) return '#ff9800';
            return '#f44336';
        };

        const temp5 = document.getElementById('schematic-soil-temp-5');
        if (temp5) temp5.textContent = (weather.soil_temp_5in === null || weather.soil_temp_5in === undefined)
            ? '--' : fmtSoil(weather.soil_temp_5in);
        const temp10 = document.getElementById('schematic-soil-temp-10');
        if (temp10) temp10.textContent = (weather.soil_temp_10in === null || weather.soil_temp_10in === undefined)
            ? '--' : fmtSoil(weather.soil_temp_10in);
        const temp20 = document.getElementById('schematic-soil-temp-20');
        if (temp20) temp20.textContent = (weather.soil_temp_20in === null || weather.soil_temp_20in === undefined)
            ? '--' : fmtSoil(weather.soil_temp_20in);

        const updateMoisture = (depth, value) => {
            const color = getMoistureColor(value);
            const textEl = document.getElementById(`schematic-soil-moisture-${depth}`);
            const rectEl = document.getElementById(`schematic-soil-moisture-${depth}-rect`);
            const pctEl = document.getElementById(`schematic-soil-moisture-${depth}-pct`);
            if (textEl) {
                textEl.textContent = (value === null || value === undefined) ? '--' : `${Number(value).toFixed(1)} cb`;
                textEl.setAttribute('fill', color);
            }
            if (rectEl) {
                rectEl.setAttribute('stroke', color);
            }
            if (pctEl) {
                const pctKey = `soil_moisture_${depth}in_percentile`;
                const pctVal = weather[pctKey];
                pctEl.textContent = (pctVal === null || pctVal === undefined) ? '--' : `${pctVal}th percentile`;
            }
        };

        updateMoisture('5', weather.soil_moisture_5in);
        updateMoisture('10', weather.soil_moisture_10in);
        updateMoisture('20', weather.soil_moisture_20in);

    } catch (error) {
        console.error('Error loading weather:', error);
        document.getElementById('loadingState').classList.add('d-none');
        document.getElementById('errorState').classList.remove('d-none');
        document.getElementById('errorMessage').textContent = error.message;
    } finally {
        refreshBtn.classList.remove('spinning');
    }
}

loadCurrentWeather();
setInterval(loadCurrentWeather, 5 * 60 * 1000);
</script>
{% endblock %}
