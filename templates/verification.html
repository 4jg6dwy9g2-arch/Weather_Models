{% extends "base.html" %}

{% block title %}ASOS Verification - Weather Forecast{% endblock %}

{% block extra_css %}
<style>
    /* ASOS Map Styles */
    #asosMap {
        background-color: #e8e8e8;
    }

    #asosMapContainer {
        background-color: #f5f5f5;
    }

    .leaflet-tooltip {
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 6px 10px;
        font-size: 13px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .leaflet-tooltip strong {
        color: #333;
    }

    /* Make dropdowns look better on the card header */
    .card-header .form-select-sm {
        padding: 0.25rem 1.75rem 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="forecast-header">
    <div class="row align-items-center">
        <div class="col-12">
            <h1 class="mb-1"><i class="bi bi-graph-up"></i> ASOS Verification</h1>
            <p class="mb-0 opacity-75">
                Model accuracy by lead time across all ASOS stations
                <span id="cacheTimestamp" class="badge bg-secondary ms-2" style="font-size: 0.7em; vertical-align: middle;">
                    <i class="bi bi-clock"></i> Cache: Loading...
                </span>
            </p>
        </div>
    </div>
</div>

<div id="loadingState" class="loading-spinner">
    <div class="text-center">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">Loading verification data...</p>
    </div>
</div>

<div id="errorState" class="alert alert-warning d-none">
    <i class="bi bi-exclamation-triangle"></i>
    <span id="errorMessage">No verification data available.</span>
    <a href="/sync" class="alert-link ms-2">Sync more forecast data to build verification history</a>
</div>

<div id="verificationContent" class="d-none">
    <!-- ASOS Station Verification Map -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <i class="bi bi-geo-alt"></i> ASOS Station Verification
                        <span class="badge bg-secondary ms-2" id="asosStationCount">-- stations</span>
                    </div>
                    <div class="d-flex gap-2 flex-wrap">
                        <select class="form-select form-select-sm" id="asosVariable" style="width: auto;">
                            <option value="temp">Temperature</option>
                            <option value="mslp">Pressure</option>
                            <option value="precip">Precipitation</option>
                        </select>
                        <select class="form-select form-select-sm" id="asosMetric" style="width: auto;">
                            <option value="mae">MAE</option>
                            <option value="bias">Bias</option>
                        </select>
                        <select class="form-select form-select-sm" id="asosModel" style="width: auto;">
                            <option value="gfs">GFS</option>
                            <option value="aifs">AIFS</option>
                            <option value="ifs">IFS</option>
                        </select>
                        <select class="form-select form-select-sm" id="asosLeadTime" style="width: auto;">
                            <option value="6" selected>6h</option>
                            <option value="12">12h</option>
                            <option value="24">24h</option>
                            <option value="48">48h</option>
                            <option value="72">72h</option>
                            <option value="120">5d</option>
                            <option value="168">7d</option>
                            <option value="240">10d</option>
                            <option value="288">12d</option>
                            <option value="360">15d</option>
                        </select>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div id="asosMapContainer" style="height: 450px; position: relative;">
                        <div id="asosMap" style="height: 100%; width: 100%;"></div>
                        <div id="asosMapLoading" class="position-absolute top-50 start-50 translate-middle text-center" style="z-index: 1000;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2 text-muted">Loading station data...</p>
                        </div>
                        <div id="asosMapEmpty" class="position-absolute top-50 start-50 translate-middle text-center d-none" style="z-index: 1000;">
                            <i class="bi bi-info-circle fs-1 text-muted"></i>
                            <p class="mt-2 text-muted">No verification data yet.<br>Sync forecasts and wait for valid times to pass.</p>
                        </div>
                    </div>
                    <!-- ASOS Station Detailed Charts -->
                    <div id="asosStationCharts" class="card-body border-top d-none">
                        <h5 class="card-title mb-3">Verification for <span id="asosStationName"></span></h5>
                        <div class="row">
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header"><i class="bi bi-thermometer-half"></i> Temperature Accuracy</div>
                                    <div class="card-body chart-container chart-container-small">
                                        <canvas id="asosTempVerificationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header"><i class="bi bi-speedometer"></i> Pressure Accuracy</div>
                                    <div class="card-body chart-container chart-container-small">
                                        <canvas id="asosMslpVerificationChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Mean Verification Table across all stations -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <i class="bi bi-table"></i> Mean Verification by Lead Time (All Stations)
                                </div>
                                <div class="card-body p-0">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>Lead Time</th>
                                                    <th>Days</th>
                                                    <th colspan="2" class="text-center bg-danger bg-opacity-10">GFS Temperature</th>
                                                    <th colspan="2" class="text-center bg-warning bg-opacity-10">AIFS Temperature</th>
                                                    <th colspan="2" class="text-center bg-success bg-opacity-10">IFS Temperature</th>
                                                    <th>Winner</th>
                                                    <th colspan="2" class="text-center bg-danger bg-opacity-10">GFS Pressure</th>
                                                    <th colspan="2" class="text-center bg-warning bg-opacity-10">AIFS Pressure</th>
                                                    <th colspan="2" class="text-center bg-success bg-opacity-10">IFS Pressure</th>
                                                    <th colspan="2" class="text-center bg-danger bg-opacity-10">GFS Precipitation</th>
                                                    <th colspan="2" class="text-center bg-warning bg-opacity-10">AIFS Precipitation</th>
                                                    <th colspan="2" class="text-center bg-success bg-opacity-10">IFS Precipitation</th>
                                                </tr>
                                                <tr>
                                                    <th></th>
                                                    <th></th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                    <th></th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                    <th class="text-center">MAE</th>
                                                    <th class="text-center">Bias</th>
                                                </tr>
                                            </thead>
                                            <tbody id="asosVerificationTableBody">
                                                <tr>
                                                    <td colspan="21" class="text-center text-muted">Loading...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Time Series Charts -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                                    <div>
                                        <i class="bi bi-graph-up"></i> Verification Trends Over Time
                                        <span class="badge bg-secondary ms-2" id="timeSeriesInfo">7-day rolling average</span>
                                    </div>
                                    <div class="d-flex gap-2 flex-wrap">
                                        <select class="form-select form-select-sm" id="tsVariable" style="width: auto;">
                                            <option value="temp">Temperature</option>
                                            <option value="mslp">Pressure</option>
                                            <option value="precip">Precipitation</option>
                                        </select>
                                        <select class="form-select form-select-sm" id="tsMetric" style="width: auto;">
                                            <option value="mae">MAE</option>
                                            <option value="bias">Bias</option>
                                        </select>
                                        <select class="form-select form-select-sm" id="tsLeadTime" style="width: auto;">
                                            <option value="6">6h</option>
                                            <option value="12">12h</option>
                                            <option value="24" selected>24h</option>
                                            <option value="48">48h</option>
                                            <option value="72">72h</option>
                                            <option value="120">5d</option>
                                            <option value="168">7d</option>
                                            <option value="240">10d</option>
                                            <option value="288">12d</option>
                                            <option value="360">15d</option>
                                        </select>
                                        <select class="form-select form-select-sm" id="tsTimeFrame" style="width: auto;">
                                            <option value="30" selected>1 month</option>
                                            <option value="90">3 months</option>
                                            <option value="180">6 months</option>
                                            <option value="365">1 year</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="position: relative; height: 400px;">
                                        <canvas id="timeSeriesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Color Scale Legend -->
                    <div class="d-flex align-items-center justify-content-center gap-3 py-2 border-top bg-light">
                        <span id="asosColorMin" class="text-muted small">0</span>
                        <div id="asosColorScale" style="width: 200px; height: 12px; border-radius: 4px;"></div>
                        <span id="asosColorMax" class="text-muted small">10</span>
                        <span id="asosUnits" class="text-muted small ms-2"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>


{% endblock %}

{% block extra_js %}
<script>
let tempMaeChart, tempBiasChart, mslpMaeChart, mslpBiasChart;

// ============================================================================
// ASOS Map Functionality
// ============================================================================

let asosMap = null;
let asosMarkers = [];

let asosTempMaeChart, asosTempBiasChart, asosMslpMaeChart, asosMslpBiasChart;
let timeSeriesChart = null;

// Format lead time for display
function formatLeadTime(hours) {
    if (hours < 24) {
        return hours + 'h';
    }
    const days = Math.floor(hours / 24);
    const remainingHours = hours % 24;
    if (remainingHours === 0) {
        return days + 'd';
    }
    return days + 'd ' + remainingHours + 'h';
}

function getVerificationChartOptions(yLabel, minY = null, showZeroLine = false) {
    const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    usePointStyle: true,
                    padding: 20
                }
            },
            annotation: {
                annotations: {}
            }
        },
        scales: {
            y: {
                grid: { color: '#e0e0e0' },
                title: { display: true, text: yLabel }
            },
            x: {
                grid: { display: false },
                title: { display: true, text: 'Lead Time' }
            }
        }
    };

    if (minY !== null) {
        options.scales.y.min = minY;
    }

    if (showZeroLine) {
        options.plugins.annotation = {
            annotations: {
                zeroLine: {
                    type: 'line',
                    yMin: 0,
                    yMax: 0,
                    borderColor: '#999',
                    borderWidth: 1,
                    borderDash: [5, 5]
                }
            }
        };
    }

    return options;
}

// Initialize ASOS map
function initAsosMap() {
    if (asosMap) return;

    // Create map centered on CONUS
    asosMap = L.map('asosMap', {
        center: [39.5, -98.5],
        zoom: 4,
        minZoom: 3,
        maxZoom: 10
    });

    // Add tile layer (OpenStreetMap)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(asosMap);

    // Initialize color scale
    // updateColorScale('mae', 0, 10);
}

// Color interpolation for MAE (green -> yellow -> red)
function getMaeColor(value, minVal, maxVal) {
    const ratio = Math.max(0, Math.min(1, (value - minVal) / (maxVal - minVal || 1)));

    // Green (#22c55e) -> Yellow (#eab308) -> Red (#ef4444)
    if (ratio < 0.5) {
        // Green to Yellow
        const t = ratio * 2;
        const r = Math.round(34 + t * (234 - 34));
        const g = Math.round(197 + t * (179 - 197));
        const b = Math.round(94 + t * (8 - 94));
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        // Yellow to Red
        const t = (ratio - 0.5) * 2;
        const r = Math.round(234 + t * (239 - 234));
        const g = Math.round(179 + t * (68 - 179));
        const b = Math.round(8 + t * (68 - 8));
        return `rgb(${r}, ${g}, ${b})`;
    }
}

// Color interpolation for Bias (blue -> white -> red)
function getBiasColor(value, minVal, maxVal) {
    // Normalize to -1 to 1
    const maxAbs = Math.max(Math.abs(minVal), Math.abs(maxVal), 0.1);
    const ratio = value / maxAbs;  // -1 to 1

    // Blue (#3b82f6) -> White (#ffffff) -> Red (#ef4444)
    if (ratio < 0) {
        // Blue to White
        const t = 1 + ratio;  // 0 to 1
        const r = Math.round(59 + t * (255 - 59));
        const g = Math.round(130 + t * (255 - 130));
        const b = Math.round(246 + t * (255 - 246));
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        // White to Red
        const t = ratio;  // 0 to 1
        const r = Math.round(255 + t * (239 - 255));
        const g = Math.round(255 + t * (68 - 255));
        const b = Math.round(255 + t * (68 - 255));
        return `rgb(${r}, ${g}, ${b})`;
    }
}

// Get color based on metric type
function getMarkerColor(value, metric, minVal, maxVal) {
    if (metric === 'bias') {
        return getBiasColor(value, minVal, maxVal);
    } else {
        return getMaeColor(value, minVal, maxVal);
    }
}

// Update color scale display
function updateColorScale(metric, minVal, maxVal) {
    const scale = document.getElementById('asosColorScale');
    const minSpan = document.getElementById('asosColorMin');
    const maxSpan = document.getElementById('asosColorMax');
    const unitsSpan = document.getElementById('asosUnits');

    const variable = document.getElementById('asosVariable').value;

    // Set units
    const units = {
        'temp': '°F',
        'mslp': 'mb',
        'precip': 'in'
    };
    unitsSpan.textContent = units[variable] || '';

    // Format values
    minSpan.textContent = minVal.toFixed(1);
    maxSpan.textContent = maxVal.toFixed(1);

    // Create gradient
    if (metric === 'bias') {
        scale.style.background = 'linear-gradient(to right, #3b82f6, #ffffff 50%, #ef4444)';
    } else {
        scale.style.background = 'linear-gradient(to right, #22c55e, #eab308 50%, #ef4444)';
    }
}

// Clear all markers
function clearAsosMarkers() {
    for (const marker of asosMarkers) {
        asosMap.removeLayer(marker);
    }
    asosMarkers = [];
}

let currentAsosTempChart = null;
let currentAsosMslpChart = null;

// Load detailed verification data for a single ASOS station
async function loadAsosStationCharts(stationId, stationName) {
    const model = document.getElementById('asosModel').value; // Get the selected model

    // Show the chart container and update the station name
    document.getElementById('asosStationCharts').classList.remove('d-none');
    document.getElementById('asosStationName').textContent = stationName;

    try {
        const response = await fetch(
            `/api/asos/station-verification?station_id=${encodeURIComponent(stationId)}&model=${encodeURIComponent(model)}`
        );
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'No detailed verification data available for this station.');
        }

        renderAsosVerificationCharts(data.verification);

    } catch (error) {
        console.error(`Error loading detailed verification for ${stationName}:`, error);
        // Optionally hide the chart section or display an error message there
        document.getElementById('asosStationCharts').classList.add('d-none');
    }
}

// Render detailed verification charts for a single ASOS station
function renderAsosVerificationCharts(v) {
    const labels = v.lead_times.map(h => formatLeadTime(h));

    // Temperature MAE and Bias Chart
    const tempDatasets = [
        {
            label: 'MAE (°F)',
            data: v.temp_mae,
            borderColor: '#dc3545',
            backgroundColor: 'rgba(220, 53, 69, 0.1)',
            fill: false,
            tension: 0.3,
            pointRadius: 3,
            borderWidth: 2,
            yAxisID: 'y'
        },
        {
            label: 'Bias (°F)',
            data: v.temp_bias,
            borderColor: '#0d6efd',
            backgroundColor: 'rgba(13, 110, 253, 0.1)',
            fill: false,
            tension: 0.3,
            pointRadius: 3,
            borderWidth: 2,
            borderDash: [5, 5],
            yAxisID: 'y1'
        }
    ];

    if (currentAsosTempChart) currentAsosTempChart.destroy();
    currentAsosTempChart = new Chart(document.getElementById('asosTempVerificationChart'), {
        type: 'line',
        data: { labels: labels, datasets: tempDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                annotation: {
                    annotations: {
                        zeroLine: {
                            type: 'line',
                            yMin: 0,
                            yMax: 0,
                            borderColor: '#999',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            yAxisID: 'y1' // Ensure zero line applies to bias axis
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    title: { display: true, text: 'Lead Time' }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: { color: '#e0e0e0' },
                    title: { display: true, text: 'MAE (°F)' },
                    min: 0 // MAE should start from 0
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false }, // Only draw grid lines for the first y-axis
                    title: { display: true, text: 'Bias (°F)' }
                }
            }
        }
    });

    // Pressure MAE and Bias Chart
    const mslpDatasets = [
        {
            label: 'MAE (mb)',
            data: v.mslp_mae,
            borderColor: '#6f42c1',
            backgroundColor: 'rgba(111, 66, 193, 0.1)',
            fill: false,
            tension: 0.3,
            pointRadius: 3,
            borderWidth: 2,
            yAxisID: 'y'
        },
        {
            label: 'Bias (mb)',
            data: v.mslp_bias,
            borderColor: '#fd7e14',
            backgroundColor: 'rgba(253, 126, 20, 0.1)',
            fill: false,
            tension: 0.3,
            pointRadius: 3,
            borderWidth: 2,
            borderDash: [5, 5],
            yAxisID: 'y1'
        }
    ];

    if (currentAsosMslpChart) currentAsosMslpChart.destroy();
    currentAsosMslpChart = new Chart(document.getElementById('asosMslpVerificationChart'), {
        type: 'line',
        data: { labels: labels, datasets: mslpDatasets },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                annotation: {
                    annotations: {
                        zeroLine: {
                            type: 'line',
                            yMin: 0,
                            yMax: 0,
                            borderColor: '#999',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            yAxisID: 'y1' // Ensure zero line applies to bias axis
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    title: { display: true, text: 'Lead Time' }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    grid: { color: '#e0e0e0' },
                    title: { display: true, text: 'MAE (mb)' },
                    min: 0 // MAE should start from 0
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    grid: { drawOnChartArea: false },
                    title: { display: true, text: 'Bias (mb)' }
                }
            }
        }
    });
}

// Load and display Mean ASOS Verification
async function loadMeanAsosVerification() {
    try {
        const response = await fetch('/api/asos/mean-verification');
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error || 'No mean verification data available.');
        }

        renderAsosVerificationTable(data.verification);

        // Update cache timestamp
        if (data.cache_timestamp) {
            const timestamp = new Date(data.cache_timestamp);
            const now = new Date();
            const ageMinutes = Math.round((now - timestamp) / 60000);

            let ageText;
            if (ageMinutes < 60) {
                ageText = `${ageMinutes}m ago`;
            } else if (ageMinutes < 1440) {
                const hours = Math.floor(ageMinutes / 60);
                ageText = `${hours}h ago`;
            } else {
                const days = Math.floor(ageMinutes / 1440);
                ageText = `${days}d ago`;
            }

            document.getElementById('cacheTimestamp').innerHTML =
                `<i class="bi bi-clock"></i> Cache: ${ageText}`;
        }

    } catch (error) {
        console.error('Error loading mean ASOS verification:', error);
        const tbody = document.getElementById('asosVerificationTableBody');
        tbody.innerHTML = '<tr><td colspan="15" class="text-center text-muted">No verification data available yet. Sync ASOS forecasts and wait for observations.</td></tr>';
    }
}

// Render ASOS verification table
function renderAsosVerificationTable(v) {
    const tbody = document.getElementById('asosVerificationTableBody');
    tbody.innerHTML = '';

    if (!v.lead_times || v.lead_times.length === 0) {
        tbody.innerHTML = '<tr><td colspan="21" class="text-center text-muted">No verification data available yet. Sync ASOS forecasts and wait for observations.</td></tr>';
        return;
    }

    for (let i = 0; i < v.lead_times.length; i++) {
        const lt = v.lead_times[i];
        const days = (lt / 24).toFixed(1);

        // Temperature data
        const gfsTempMae = v.gfs_temp_mae[i];
        const gfsTempBias = v.gfs_temp_bias[i];
        const aifsTempMae = v.aifs_temp_mae[i];
        const aifsTempBias = v.aifs_temp_bias[i];
        const ifsTempMae = v.ifs_temp_mae ? v.ifs_temp_mae[i] : null;
        const ifsTempBias = v.ifs_temp_bias ? v.ifs_temp_bias[i] : null;

        // Pressure data
        const gfsMslpMae = v.gfs_mslp_mae[i];
        const gfsMslpBias = v.gfs_mslp_bias[i];
        const aifsMslpMae = v.aifs_mslp_mae[i];
        const aifsMslpBias = v.aifs_mslp_bias[i];
        const ifsMslpMae = v.ifs_mslp_mae ? v.ifs_mslp_mae[i] : null;
        const ifsMslpBias = v.ifs_mslp_bias ? v.ifs_mslp_bias[i] : null;

        // Precipitation data
        const gfsPrecipMae = v.gfs_precip_mae ? v.gfs_precip_mae[i] : null;
        const gfsPrecipBias = v.gfs_precip_bias ? v.gfs_precip_bias[i] : null;
        const aifsPrecipMae = v.aifs_precip_mae ? v.aifs_precip_mae[i] : null;
        const aifsPrecipBias = v.aifs_precip_bias ? v.aifs_precip_bias[i] : null;
        const ifsPrecipMae = v.ifs_precip_mae ? v.ifs_precip_mae[i] : null;
        const ifsPrecipBias = v.ifs_precip_bias ? v.ifs_precip_bias[i] : null;

        // Determine temperature winner
        let winner = '--';
        let winnerClass = 'badge bg-secondary';
        const tempMaes = [
            { name: 'GFS', mae: gfsTempMae, class: 'badge bg-danger' },
            { name: 'AIFS', mae: aifsTempMae, class: 'badge bg-warning text-dark' },
            { name: 'IFS', mae: ifsTempMae, class: 'badge bg-success' }
        ].filter(m => m.mae !== null && m.mae !== undefined);

        if (tempMaes.length > 0) {
            const minMae = Math.min(...tempMaes.map(m => m.mae));
            const winners = tempMaes.filter(m => m.mae === minMae);
            if (winners.length === 1) {
                winner = winners[0].name;
                winnerClass = winners[0].class;
            } else {
                winner = 'Tie';
            }
        }

        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${formatLeadTime(lt)}</strong></td>
            <td>${days}</td>
            <td class="text-center">${gfsTempMae !== null ? gfsTempMae.toFixed(1) + '°F' : '--'}</td>
            <td class="text-center">${gfsTempBias !== null ? (gfsTempBias > 0 ? '+' : '') + gfsTempBias.toFixed(1) + '°F' : '--'}</td>
            <td class="text-center">${aifsTempMae !== null ? aifsTempMae.toFixed(1) + '°F' : '--'}</td>
            <td class="text-center">${aifsTempBias !== null ? (aifsTempBias > 0 ? '+' : '') + aifsTempBias.toFixed(1) + '°F' : '--'}</td>
            <td class="text-center">${ifsTempMae !== null && ifsTempMae !== undefined ? ifsTempMae.toFixed(1) + '°F' : '--'}</td>
            <td class="text-center">${ifsTempBias !== null && ifsTempBias !== undefined ? (ifsTempBias > 0 ? '+' : '') + ifsTempBias.toFixed(1) + '°F' : '--'}</td>
            <td><span class="${winnerClass}">${winner}</span></td>
            <td class="text-center">${gfsMslpMae !== null ? gfsMslpMae.toFixed(1) + ' mb' : '--'}</td>
            <td class="text-center">${gfsMslpBias !== null ? (gfsMslpBias > 0 ? '+' : '') + gfsMslpBias.toFixed(1) + ' mb' : '--'}</td>
            <td class="text-center">${aifsMslpMae !== null ? aifsMslpMae.toFixed(1) + ' mb' : '--'}</td>
            <td class="text-center">${aifsMslpBias !== null ? (aifsMslpBias > 0 ? '+' : '') + aifsMslpBias.toFixed(1) + ' mb' : '--'}</td>
            <td class="text-center">${ifsMslpMae !== null && ifsMslpMae !== undefined ? ifsMslpMae.toFixed(1) + ' mb' : '--'}</td>
            <td class="text-center">${ifsMslpBias !== null && ifsMslpBias !== undefined ? (ifsMslpBias > 0 ? '+' : '') + ifsMslpBias.toFixed(1) + ' mb' : '--'}</td>
            <td class="text-center">${gfsPrecipMae !== null && gfsPrecipMae !== undefined ? gfsPrecipMae.toFixed(2) + ' in' : '--'}</td>
            <td class="text-center">${gfsPrecipBias !== null && gfsPrecipBias !== undefined ? (gfsPrecipBias > 0 ? '+' : '') + gfsPrecipBias.toFixed(2) + ' in' : '--'}</td>
            <td class="text-center">${aifsPrecipMae !== null && aifsPrecipMae !== undefined ? aifsPrecipMae.toFixed(2) + ' in' : '--'}</td>
            <td class="text-center">${aifsPrecipBias !== null && aifsPrecipBias !== undefined ? (aifsPrecipBias > 0 ? '+' : '') + aifsPrecipBias.toFixed(2) + ' in' : '--'}</td>
            <td class="text-center">${ifsPrecipMae !== null && ifsPrecipMae !== undefined ? ifsPrecipMae.toFixed(2) + ' in' : '--'}</td>
            <td class="text-center">${ifsPrecipBias !== null && ifsPrecipBias !== undefined ? (ifsPrecipBias > 0 ? '+' : '') + ifsPrecipBias.toFixed(2) + ' in' : '--'}</td>
        `;
        tbody.appendChild(row);
    }
}


// Load and display ASOS verification data
async function loadAsosVerification() {
    if (!asosMap) {
        initAsosMap();
    }
    // Hide station charts when map is reloaded
    document.getElementById('asosStationCharts').classList.add('d-none');

    const variable = document.getElementById('asosVariable').value;
    const metric = document.getElementById('asosMetric').value;
    const model = document.getElementById('asosModel').value;
    const leadTime = document.getElementById('asosLeadTime').value;

    console.log(`[loadAsosVerification] Fetching map data for variable=${variable}, metric=${metric}, model=${model}, leadTime=${leadTime}`);

    // Show loading
    document.getElementById('asosMapLoading').classList.remove('d-none');
    document.getElementById('asosMapEmpty').classList.add('d-none');

    try {
        const response = await fetch(
            `/api/asos/verification-map?variable=${variable}&metric=${metric}&model=${model}&lead_time=${leadTime}`
        );
        console.log('[loadAsosVerification] Received response:', response);

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('[loadAsosVerification] Received data:', data);

        // Hide loading and show content
        document.getElementById('asosMapLoading').classList.add('d-none');
        document.getElementById('loadingState').classList.add('d-none'); // Hide main loading spinner
        document.getElementById('verificationContent').classList.remove('d-none');
        asosMap.invalidateSize(); // Invalidate map size after container is visible


        if (!data.success) {
            console.error('[loadAsosVerification] ASOS verification error from API:', data.error);
            document.getElementById('asosMapEmpty').classList.remove('d-none');
            // Ensure map loading spinner is hidden on API error
            document.getElementById('asosMapLoading').classList.add('d-none');
            return;
        }

        const stations = data.stations || [];
        console.log(`[loadAsosVerification] Found ${stations.length} stations.`);

        // Update station count
        document.getElementById('asosStationCount').textContent = `${stations.length} stations`;

        if (stations.length === 0) {
            console.log('[loadAsosVerification] No stations to display, showing empty message.');
            document.getElementById('asosMapEmpty').classList.remove('d-none');
            clearAsosMarkers();
            // Ensure map loading spinner is hidden when no stations
            document.getElementById('asosMapLoading').classList.add('d-none');
            return;
        }

        // Update color scale
        updateColorScale(metric, data.min_value, data.max_value);

        // Clear existing markers
        clearAsosMarkers();

        // Add new markers
        for (const station of stations) {
            if (!station.lat || !station.lon) continue;

            const color = getMarkerColor(station.value, metric, data.min_value, data.max_value);

            const marker = L.circleMarker([station.lat, station.lon], {
                radius: 6,
                fillColor: color,
                color: '#333',
                weight: 1,
                opacity: 0.8,
                fillOpacity: 0.9
            });

            // Create tooltip content
            const metricLabel = metric.toUpperCase();
            const units = {
                'temp': '°F',
                'mslp': 'mb',
                'precip': 'in'
            };
            const unit = units[variable] || '';

            const tooltipContent = `
                <strong>${station.name}</strong> (${station.station_id})<br>
                ${metricLabel}: ${station.value.toFixed(1)}${unit}<br>
                Samples: ${station.count}
            `;

            marker.bindTooltip(tooltipContent, {
                direction: 'top',
                offset: [0, -5]
            });

            marker.on('click', function() {
                loadAsosStationCharts(station.station_id, station.name);
            });

            marker.addTo(asosMap);
            asosMarkers.push(marker);
        }

    } catch (error) {
        console.error('[loadAsosVerification] Error during fetch or processing:', error);
        document.getElementById('asosMapLoading').classList.add('d-none');
        document.getElementById('asosMapEmpty').classList.remove('d-none');
    }
}

// Calculate 7-day rolling average
function calculateRollingAverage(data, window = 7) {
    const result = [];
    for (let i = 0; i < data.length; i++) {
        const start = Math.max(0, i - window + 1);
        const subset = data.slice(start, i + 1).filter(v => v !== null && v !== undefined);
        if (subset.length > 0) {
            const avg = subset.reduce((sum, val) => sum + val, 0) / subset.length;
            result.push(avg);
        } else {
            result.push(null);
        }
    }
    return result;
}

// Load and display time series chart
async function loadTimeSeriesChart() {
    const variable = document.getElementById('tsVariable').value;
    const metric = document.getElementById('tsMetric').value;
    const leadTime = document.getElementById('tsLeadTime').value;
    const timeFrame = document.getElementById('tsTimeFrame').value;

    try {
        const response = await fetch(
            `/api/asos/verification-time-series?variable=${variable}&lead_time=${leadTime}&days_back=${timeFrame}`
        );
        const data = await response.json();

        if (!data.success) {
            console.error('Error loading time series:', data.error);
            return;
        }

        renderTimeSeriesChart(data, metric);

    } catch (error) {
        console.error('Error loading time series chart:', error);
    }
}

// Render time series chart
function renderTimeSeriesChart(data, metric) {
    const ctx = document.getElementById('timeSeriesChart');

    // Get the appropriate data arrays based on metric
    const gfsData = metric === 'mae' ? data.gfs.mae : data.gfs.bias;
    const aifsData = metric === 'mae' ? data.aifs.mae : data.aifs.bias;
    const ifsData = metric === 'mae' ? data.ifs.mae : data.ifs.bias;

    // Calculate 7-day rolling averages
    const gfsRolling = calculateRollingAverage(gfsData);
    const aifsRolling = calculateRollingAverage(aifsData);
    const ifsRolling = calculateRollingAverage(ifsData);

    // Format dates for display
    const labels = data.dates.map(d => {
        const date = new Date(d);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    // Determine units and labels
    const variable = document.getElementById('tsVariable').value;
    const units = {
        'temp': '°F',
        'mslp': 'mb',
        'precip': 'in'
    };
    const unit = units[variable] || '';
    const metricLabel = metric.toUpperCase();
    const yAxisLabel = `${metricLabel} (${unit})`;

    // Destroy existing chart
    if (timeSeriesChart) {
        timeSeriesChart.destroy();
    }

    // Create new chart
    timeSeriesChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'GFS',
                    data: gfsRolling,
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 1,
                    pointHoverRadius: 4
                },
                {
                    label: 'AIFS',
                    data: aifsRolling,
                    borderColor: '#ffc107',
                    backgroundColor: 'rgba(255, 193, 7, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 1,
                    pointHoverRadius: 4
                },
                {
                    label: 'IFS',
                    data: ifsRolling,
                    borderColor: '#198754',
                    backgroundColor: 'rgba(25, 135, 84, 0.1)',
                    borderWidth: 2,
                    tension: 0.3,
                    pointRadius: 1,
                    pointHoverRadius: 4
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(2) + ' ' + unit;
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: { color: '#e0e0e0' },
                    title: {
                        display: true,
                        text: yAxisLabel
                    }
                },
                x: {
                    grid: { display: false },
                    title: {
                        display: true,
                        text: 'Date'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
}

// Event listeners for ASOS controls
document.getElementById('asosVariable').addEventListener('change', loadAsosVerification);
document.getElementById('asosMetric').addEventListener('change', loadAsosVerification);
document.getElementById('asosModel').addEventListener('change', loadAsosVerification);
document.getElementById('asosLeadTime').addEventListener('change', loadAsosVerification);

// Event listeners for time series controls
document.getElementById('tsVariable').addEventListener('change', loadTimeSeriesChart);
document.getElementById('tsMetric').addEventListener('change', loadTimeSeriesChart);
document.getElementById('tsLeadTime').addEventListener('change', loadTimeSeriesChart);
document.getElementById('tsTimeFrame').addEventListener('change', loadTimeSeriesChart);

// Initial load
document.addEventListener('DOMContentLoaded', function() {
    initAsosMap();
    setTimeout(loadAsosVerification, 50); // Small delay
    setTimeout(loadMeanAsosVerification, 250); // Small delay for mean verification after map
    setTimeout(loadTimeSeriesChart, 300); // Load time series chart
});


</script>
{% endblock %}
