{% extends "base.html" %}

{% block title %}Sync - Weather Forecast{% endblock %}

{% block extra_css %}
<style>
    .sync-header {
        background: linear-gradient(135deg, #6f42c1 0%, #0088cc 100%);
        color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .sync-card {
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .sync-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }

    .sync-btn {
        min-width: 150px;
    }

    .progress-container {
        display: none;
    }

    .progress-container.active {
        display: block;
    }

    .log-output {
        background-color: #1d1d1f;
        color: #00ff00;
        font-family: 'Monaco', 'Menlo', monospace;
        font-size: 0.85rem;
        padding: 1rem;
        border-radius: 8px;
        max-height: 500px;
        overflow-y: auto;
        overflow-x: hidden;
    }

    .log-entry {
        margin-bottom: 0.25rem;
    }

    .log-entry.error {
        color: #ff6b6b;
        font-weight: bold;
    }

    .log-entry.success {
        color: #51cf66;
    }

    .log-entry.warning {
        color: #ffc107;
    }

    .log-entry.info {
        color: #74c0fc;
    }

    .saved-file-badge {
        background-color: rgba(0, 168, 107, 0.15);
        color: #00a86b;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-family: monospace;
        font-size: 0.85rem;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 8px;
    }

    .status-idle { background-color: #adb5bd; }
    .status-running { background-color: #ffc107; animation: pulse 1s infinite; }
    .status-success { background-color: #28a745; }
    .status-error { background-color: #dc3545; }

    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }
</style>
{% endblock %}

{% block content %}
<div class="sync-header">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h1 class="mb-1"><i class="bi bi-cloud-download"></i> Sync Model Data</h1>
            <p class="mb-0 opacity-75">Fetch the latest forecast data from GFS, ECMWF AIFS, and ECMWF IFS</p>
        </div>
        <div class="col-md-4 text-md-end">
            <span class="status-indicator status-idle" id="statusIndicator"></span>
            <span id="statusText">Ready</span>
        </div>
    </div>
</div>

<!-- Sync Buttons -->
<div class="row mb-4">
    <div class="col-12 text-center">
        <button class="btn btn-primary btn-lg sync-btn me-2" id="syncBtn" onclick="startSync(false)">
            <i class="bi bi-cloud-download"></i> Sync All Data
        </button>
        <button class="btn btn-outline-secondary btn-lg sync-btn" id="forceSyncBtn" onclick="startSync(true)">
            <i class="bi bi-arrow-repeat"></i> Force Refresh All
        </button>
        <p class="text-muted mt-2 mb-0">
            <small>Syncs latest available model runs for Fairfax forecasts and ASOS stations. Force Refresh always re-downloads everything.</small>
        </p>
    </div>
</div>

<!-- Progress Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" id="progressCard" style="display: none;">
            <div class="card-header">
                <i class="bi bi-terminal"></i> Sync Progress
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 24px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="progressBar"
                         role="progressbar" style="width: 0%">0%</div>
                </div>
                <div class="log-output" id="logOutput">
                    <div class="log-entry info">Waiting to start...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div class="row mb-4" id="resultsSection" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-check-circle"></i> Sync Complete
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6>Saved to:</h6>
                        <div class="saved-file-badge" id="savedFilePath">--</div>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <a href="/" class="btn btn-primary">
                            <i class="bi bi-speedometer2"></i> View Dashboard
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card text-center p-3">
                            <div class="stat-value stat-value-gfs" id="resultGfsHigh">--</div>
                            <div class="stat-label">GFS High</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card text-center p-3">
                            <div class="stat-value stat-value-aifs" id="resultAifsHigh">--</div>
                            <div class="stat-label">AIFS High</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card text-center p-3">
                            <div class="stat-value stat-value-ifs" id="resultIfsHigh">--</div>
                            <div class="stat-label">IFS High</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card text-center p-3">
                            <div class="stat-value stat-value-gfs" id="resultGfsInit">--</div>
                            <div class="stat-label">GFS Init</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card text-center p-3">
                            <div class="stat-value stat-value-aifs" id="resultAifsInit">--</div>
                            <div class="stat-label">AIFS Init</div>
                        </div>
                    </div>
                    <div class="col-lg-2 col-md-4 col-6">
                        <div class="stat-card text-center p-3">
                            <div class="stat-value stat-value-ifs" id="resultIfsInit">--</div>
                            <div class="stat-label">IFS Init</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Saved Forecasts -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-archive"></i> Saved Forecasts</span>
                <button class="btn btn-sm btn-outline-light" onclick="loadSavedForecasts()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Location</th>
                                <th>Fetched At</th>
                                <th>GFS Init</th>
                                <th>AIFS Init</th>
                                <th>IFS Init</th>
                            </tr>
                        </thead>
                        <tbody id="savedForecastsTable">
                            <tr>
                                <td colspan="5" class="text-center text-muted">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isSyncing = false;
let eventSource = null;

function formatDateTime(isoStr) {
    if (!isoStr) return '--';
    const date = new Date(isoStr);
    return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        hour12: true
    });
}

function formatInitTime(isoStr) {
    if (!isoStr) return '--';
    const date = new Date(isoStr);
    return date.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        hour12: false,
        timeZone: 'UTC'
    }) + 'Z';
}

function addLog(message, type = 'info') {
    const logOutput = document.getElementById('logOutput');

    // Check if user is near bottom (within 50px)
    const isNearBottom = logOutput.scrollHeight - logOutput.scrollTop - logOutput.clientHeight < 50;

    const entry = document.createElement('div');
    entry.className = `log-entry ${type}`;
    entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    logOutput.appendChild(entry);

    // Only auto-scroll if user was already near the bottom
    if (isNearBottom) {
        logOutput.scrollTop = logOutput.scrollHeight;
    }
}

function updateProgress(percent, message) {
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = `${percent}%`;
    progressBar.textContent = `${percent}%`;
    if (message) addLog(message);
}

function setStatus(status, text) {
    const indicator = document.getElementById('statusIndicator');
    const statusText = document.getElementById('statusText');

    indicator.className = `status-indicator status-${status}`;
    statusText.textContent = text;
}

async function startSync(force = false) {
    if (isSyncing) return;

    isSyncing = true;

    // Show progress card, hide results
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('logOutput').innerHTML = '';

    // Update UI
    document.getElementById('syncBtn').disabled = true;
    document.getElementById('forceSyncBtn').disabled = true;
    document.getElementById('syncBtn').innerHTML = '<span class="spinner-border spinner-border-sm"></span> Syncing...';
    setStatus('running', 'Syncing all data...');

    addLog('Connecting to sync stream...', 'info');
    updateProgress(5, null);

    // Always use latest available initialization time
    const initHourValue = 'auto';

    // Connect to SSE stream for real-time logs
    if (eventSource) {
        eventSource.close();
    }

    eventSource = new EventSource('/api/sync-logs');

    eventSource.onmessage = function(event) {
        const data = JSON.parse(event.data);
        addLog(data.message, data.type);

        // Update progress bar based on log content
        if (data.message.includes('Step 1/2')) {
            updateProgress(10, null);
        } else if (data.message.includes('GFS data fetched')) {
            updateProgress(20, null);
        } else if (data.message.includes('AIFS data fetched')) {
            updateProgress(30, null);
        } else if (data.message.includes('IFS data fetched')) {
            updateProgress(35, null);
        } else if (data.message.includes('Step 2/2')) {
            updateProgress(40, null);
        } else if (data.message.includes('GFS ASOS data synced')) {
            updateProgress(60, null);
        } else if (data.message.includes('AIFS ASOS data synced')) {
            updateProgress(75, null);
        } else if (data.message.includes('IFS ASOS data synced')) {
            updateProgress(85, null);
        } else if (data.message.includes('Fetched') && data.message.includes('observations')) {
            updateProgress(95, null);
        } else if (data.message.includes('SYNC COMPLETED')) {
            updateProgress(100, null);
        }
    };

    eventSource.onerror = function(error) {
        console.error('SSE Error:', error);
        eventSource.close();
    };

    try {
        // Build query parameters
        const params = new URLSearchParams();
        if (force) params.append('force', 'true');
        if (initHourValue !== 'auto') params.append('init_hour', initHourValue);

        const queryString = params.toString();
        const url = `/api/sync-all${queryString ? '?' + queryString : ''}`;

        const response = await fetch(url);
        const data = await response.json();

        if (!data.success) {
            throw new Error(data.errors?.join(', ') || 'Sync failed');
        }

        // Close SSE connection
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }

        setStatus('success', 'All data synced');

        // Update results section - show summary
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('savedFilePath').textContent = 'forecasts.json & asos_forecasts.json';

        // Note: We don't have individual model data in the response anymore
        // Show init times if available
        if (data.fairfax.init_time) {
            document.getElementById('resultGfsInit').textContent = formatInitTime(data.fairfax.init_time);
            document.getElementById('resultAifsInit').textContent = formatInitTime(data.fairfax.init_time);
            document.getElementById('resultIfsInit').textContent = formatInitTime(data.fairfax.init_time);
        }

        // Set generic success message for highs
        document.getElementById('resultGfsHigh').textContent = 'Synced';
        document.getElementById('resultAifsHigh').textContent = 'Synced';
        document.getElementById('resultIfsHigh').textContent = 'Synced';

        // Refresh saved forecasts list
        loadSavedForecasts();

    } catch (error) {
        addLog(`Error: ${error.message}`, 'error');
        setStatus('error', 'Sync failed');
        updateProgress(0, '');

        // Close SSE connection on error
        if (eventSource) {
            eventSource.close();
            eventSource = null;
        }
    } finally {
        isSyncing = false;
        document.getElementById('syncBtn').disabled = false;
        document.getElementById('forceSyncBtn').disabled = false;
        document.getElementById('syncBtn').innerHTML = '<i class="bi bi-cloud-download"></i> Sync All Data';
    }
}

async function loadSavedForecasts() {
    const tbody = document.getElementById('savedForecastsTable');

    try {
        const response = await fetch('/api/saved-forecasts');
        const data = await response.json();

        if (!data.success || data.forecasts.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No saved forecasts</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        data.forecasts.forEach(f => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><strong>${f.location}</strong></td>
                <td>${formatDateTime(f.fetched_at)}</td>
                <td>${formatInitTime(f.gfs_init)}</td>
                <td>${formatInitTime(f.aifs_init)}</td>
                <td>${formatInitTime(f.ifs_init)}</td>
            `;
            tbody.appendChild(row);
        });

    } catch (error) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load</td></tr>';
    }
}

// Load saved forecasts on page load
document.addEventListener('DOMContentLoaded', loadSavedForecasts);
</script>
{% endblock %}
