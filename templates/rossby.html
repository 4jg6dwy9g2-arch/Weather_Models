{% extends "base.html" %}

{% block title %}Rossby Wave Analysis{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-wind"></i> Rossby Wave Analysis
    </h1>

    <!-- Current Wave State Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-broadcast"></i> Current Wave State (500 hPa, 55°N)
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h5>GFS</h5>
                            <div class="display-4 text-primary" id="gfs-wave-number">-</div>
                            <small class="text-muted">waves</small>
                            <div class="mt-2">
                                <small id="gfs-wave-detail" class="text-muted"></small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>AIFS</h5>
                            <div class="display-4 text-warning" id="aifs-wave-number">-</div>
                            <small class="text-muted">waves</small>
                            <div class="mt-2">
                                <small id="aifs-wave-detail" class="text-muted"></small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>IFS</h5>
                            <div class="display-4 text-success" id="ifs-wave-number">-</div>
                            <small class="text-muted">waves</small>
                            <div class="mt-2">
                                <small id="ifs-wave-detail" class="text-muted"></small>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <strong>Method:</strong> Wave numbers calculated using spectral decomposition (Blackmon et al., 1984; Branstator, 1987).
                        Lower wave numbers (2-4) indicate larger, more persistent patterns with better forecast reliability.
                        Higher wave numbers (5-8+) suggest faster-evolving, more chaotic patterns with reduced predictability.
                        Amplitude shows the strength of the dominant wave pattern in meters, while variance indicates the percentage of height variability explained by that wave.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wave Forecast & History Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <span><i class="bi bi-graph-up"></i> Wave Number Forecast & History</span>
                    <select class="form-select form-select-sm" id="waveHistoryDays" style="width: auto;">
                        <option value="7">1 week history</option>
                        <option value="14">2 weeks history</option>
                        <option value="30" selected>1 month history</option>
                        <option value="60">2 months history</option>
                        <option value="90">3 months history</option>
                    </select>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="waveChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Predictability Analysis Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-graph-down"></i> Predictability Analysis
                </div>
                <div class="card-body">
                    <!-- Predictability Indicator -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Current Predictability</h6>
                                    <div class="display-4" id="predictability-status">-</div>
                                    <small class="text-muted" id="predictability-detail">Loading...</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Expected 72h Temp Error</h6>
                                    <div class="display-4 text-primary" id="expected-error-72h">-</div>
                                    <small class="text-muted">Based on current wave pattern</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Expected 120h Temp Error</h6>
                                    <div class="display-4 text-warning" id="expected-error-120h">-</div>
                                    <small class="text-muted">Based on current wave pattern</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>About Predictability Analysis:</strong> This analysis correlates historical Rossby wave patterns
                        with forecast errors to provide uncertainty estimates. Certain wave configurations (e.g., high wave numbers,
                        large amplitudes, rapid transitions) are associated with degraded forecast skill. This gives you context
                        about how much to trust extended forecasts based on current atmospheric flow regime.
                    </div>

                    <!-- Wave Number vs Error Correlation Chart -->
                    <div class="mt-4">
                        <h6>Wave Number vs Forecast Error (Last 90 Days)</h6>
                        <div class="chart-container" style="position: relative; height: 350px;">
                            <canvas id="waveErrorChart"></canvas>
                        </div>
                    </div>

                    <!-- Amplitude vs Error Correlation Chart -->
                    <div class="mt-4">
                        <h6>Wave Amplitude vs Forecast Error (Last 90 Days)</h6>
                        <div class="chart-container" style="position: relative; height: 350px;">
                            <canvas id="amplitudeErrorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scientific Background -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-book"></i> Scientific Background
                </div>
                <div class="card-body">
                    <h6>What are Rossby Waves?</h6>
                    <p>
                        Rossby waves are large-scale meanders in high-altitude winds (like the jet stream) caused by Earth's rotation.
                        They transfer heat and momentum across latitudes and govern weather patterns. The "wave number" indicates how many
                        complete wave patterns circle the globe at a given latitude.
                    </p>

                    <h6 class="mt-3">Why does wave number matter for forecasts?</h6>
                    <ul>
                        <li><strong>Low wave numbers (2-4):</strong> Large, slow-moving patterns. More persistent and predictable. Forecasts remain skillful for 7-10 days.</li>
                        <li><strong>Medium wave numbers (5-6):</strong> Typical synoptic patterns. Moderate predictability. Forecasts useful for 5-7 days.</li>
                        <li><strong>High wave numbers (7-9):</strong> Small, fast-evolving patterns. Less predictable. Forecast skill degrades beyond 3-5 days.</li>
                    </ul>

                    <h6 class="mt-3">Key Research</h6>
                    <ul class="mb-0">
                        <li><strong>Blackmon et al. (1984):</strong> Established spectral analysis methods for identifying planetary-scale waves in the atmosphere.</li>
                        <li><strong>Kornhuber et al. (2017, 2019):</strong> Showed that quasi-stationary wave patterns with wave numbers 6-8 are associated with persistent weather extremes and reduced forecast skill.</li>
                        <li><strong>Matsueda & Palmer (2018):</strong> Demonstrated that forecast skill depends critically on the atmospheric flow regime, with blocked patterns showing 20-30% skill reduction.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// Rossby Wave Analysis - JavaScript
// ============================================================================

let waveChart = null;
let waveErrorChart = null;
let amplitudeErrorChart = null;

// Load all data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadWaveAnalysis();
    loadWaveChart();
    loadPredictabilityAnalysis();
});

// Event listeners
document.getElementById('waveHistoryDays').addEventListener('change', loadWaveChart);

// ============================================================================
// Current Wave State
// ============================================================================

async function loadWaveAnalysis() {
    try {
        const response = await fetch('/api/wave-analysis?location=Fairfax,%20VA');
        const data = await response.json();

        if (!data.success) {
            console.error('Error loading wave analysis:', data.error);
            return;
        }

        // Update GFS
        if (data.gfs_waves && data.gfs_waves.wave_number !== null) {
            document.getElementById('gfs-wave-number').textContent = data.gfs_waves.wave_number;
            const amp = data.gfs_waves.top_3_amplitudes ? data.gfs_waves.top_3_amplitudes[0].toFixed(0) : 'N/A';
            const var_exp = data.gfs_waves.top_3_variance ? data.gfs_waves.top_3_variance[0].toFixed(1) : 'N/A';
            document.getElementById('gfs-wave-detail').textContent =
                `Amplitude: ${amp}m, Variance: ${var_exp}%`;
        } else {
            document.getElementById('gfs-wave-number').textContent = '-';
            document.getElementById('gfs-wave-detail').textContent = '';
        }

        // Update AIFS
        if (data.aifs_waves && data.aifs_waves.wave_number !== null) {
            document.getElementById('aifs-wave-number').textContent = data.aifs_waves.wave_number;
            const amp = data.aifs_waves.top_3_amplitudes ? data.aifs_waves.top_3_amplitudes[0].toFixed(0) : 'N/A';
            const var_exp = data.aifs_waves.top_3_variance ? data.aifs_waves.top_3_variance[0].toFixed(1) : 'N/A';
            document.getElementById('aifs-wave-detail').textContent =
                `Amplitude: ${amp}m, Variance: ${var_exp}%`;
        } else {
            document.getElementById('aifs-wave-number').textContent = '-';
            document.getElementById('aifs-wave-detail').textContent = '';
        }

        // Update IFS
        if (data.ifs_waves && data.ifs_waves.wave_number !== null) {
            document.getElementById('ifs-wave-number').textContent = data.ifs_waves.wave_number;
            const amp = data.ifs_waves.top_3_amplitudes ? data.ifs_waves.top_3_amplitudes[0].toFixed(0) : 'N/A';
            const var_exp = data.ifs_waves.top_3_variance ? data.ifs_waves.top_3_variance[0].toFixed(1) : 'N/A';
            document.getElementById('ifs-wave-detail').textContent =
                `Amplitude: ${amp}m, Variance: ${var_exp}%`;
        } else {
            document.getElementById('ifs-wave-number').textContent = '-';
            document.getElementById('ifs-wave-detail').textContent = '';
        }
    } catch (error) {
        console.error('Error loading wave analysis:', error);
    }
}

// ============================================================================
// Wave Forecast & History Chart
// ============================================================================

async function loadWaveChart() {
    const daysBack = document.getElementById('waveHistoryDays').value;

    try {
        const [historyResponse, forecastResponse] = await Promise.all([
            fetch(`/api/wave-time-series?location=Fairfax,%20VA&days_back=${daysBack}`),
            fetch('/api/wave-forecast?location=Fairfax,%20VA')
        ]);

        const historyData = await historyResponse.json();
        const forecastData = await forecastResponse.json();

        renderWaveChart(historyData, forecastData);
    } catch (error) {
        console.error('Error loading wave chart:', error);
    }
}

function renderWaveChart(historyData, forecastData) {
    const ctx = document.getElementById('waveChart');

    if (waveChart) {
        waveChart.destroy();
    }

    const datasets = [];

    // Add historical data
    if (historyData.success && historyData.dates && historyData.dates.length > 0) {
        datasets.push({
            label: 'History',
            data: historyData.gfs,
            borderColor: '#000000',
            backgroundColor: 'rgba(0, 0, 0, 0.05)',
            borderWidth: 2.5,
            tension: 0.3,
            pointRadius: 2,
            pointHoverRadius: 5,
            spanGaps: true
        });
    }

    // Add forecast data for each model
    if (forecastData.success) {
        const gfsForecast = forecastData.gfs_forecast || {};
        const aifsForecast = forecastData.aifs_forecast || {};
        const ifsForecast = forecastData.ifs_forecast || {};

        if (gfsForecast.times && gfsForecast.times.length > 0) {
            datasets.push({
                label: 'GFS Forecast',
                data: gfsForecast.wave_numbers || [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
                spanGaps: true
            });
        }

        if (aifsForecast.wave_numbers && aifsForecast.wave_numbers.length > 0) {
            datasets.push({
                label: 'AIFS Forecast',
                data: aifsForecast.wave_numbers || [],
                borderColor: '#0dcaf0',
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
                spanGaps: true
            });
        }

        if (ifsForecast.wave_numbers && ifsForecast.wave_numbers.length > 0) {
            datasets.push({
                label: 'IFS Forecast',
                data: ifsForecast.wave_numbers || [],
                borderColor: '#20c997',
                backgroundColor: 'rgba(32, 201, 151, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
                spanGaps: true
            });
        }
    }

    // Combine all labels
    let allLabels = [];
    if (historyData.success && historyData.dates) {
        allLabels = historyData.dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    }
    if (forecastData.success && forecastData.gfs_forecast && forecastData.gfs_forecast.times) {
        const forecastLabels = forecastData.gfs_forecast.times.map(t => new Date(t).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        allLabels = allLabels.concat(forecastLabels);
    }

    // Pad datasets
    const historyLength = historyData.success && historyData.dates ? historyData.dates.length : 0;
    datasets.forEach(dataset => {
        if (dataset.label !== 'History') {
            const forecastData = dataset.data.filter(d => d !== null);
            dataset.data = Array(historyLength).fill(null).concat(forecastData);
        }
    });

    waveChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: allLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { usePointStyle: true, padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(1) + ' waves';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: { color: '#e0e0e0' },
                    title: { display: true, text: 'Wave Number' },
                    min: 0,
                    max: 10,
                    ticks: { stepSize: 1 }
                },
                x: {
                    grid: { color: '#f0f0f0' },
                    ticks: { maxRotation: 45, minRotation: 45 }
                }
            }
        }
    });
}

// ============================================================================
// Predictability Analysis
// ============================================================================

async function loadPredictabilityAnalysis() {
    try {
        const response = await fetch('/api/wave-skill-correlation?location=Fairfax,%20VA');
        const data = await response.json();

        if (!data.success) {
            console.error('Error loading predictability analysis:', data.error);
            document.getElementById('predictability-status').textContent = 'N/A';
            document.getElementById('predictability-detail').textContent = 'Data not available';
            document.getElementById('expected-error-72h').textContent = '-';
            document.getElementById('expected-error-120h').textContent = '-';
            return;
        }

        // Update predictability status
        const currentWave = data.current_wave_number || 0;
        const status = data.predictability_status || 'Unknown';
        const confidence = data.confidence || 'Low';

        document.getElementById('predictability-status').textContent = status;
        document.getElementById('predictability-status').className = 'display-4 ' +
            (status === 'HIGH' ? 'text-success' : status === 'MEDIUM' ? 'text-warning' : 'text-danger');
        document.getElementById('predictability-detail').textContent =
            `Wave ${currentWave} | Confidence: ${confidence}`;

        // Update expected errors
        const error72h = data.expected_error_72h || 0;
        const error120h = data.expected_error_120h || 0;
        document.getElementById('expected-error-72h').textContent = error72h > 0 ? `±${error72h.toFixed(1)}°F` : '-';
        document.getElementById('expected-error-120h').textContent = error120h > 0 ? `±${error120h.toFixed(1)}°F` : '-';

        // Render correlation charts
        if (data.wave_error_correlation) {
            renderWaveErrorChart(data.wave_error_correlation);
        }
        if (data.amplitude_error_correlation) {
            renderAmplitudeErrorChart(data.amplitude_error_correlation);
        }

    } catch (error) {
        console.error('Error loading predictability analysis:', error);
    }
}

function renderWaveErrorChart(data) {
    const ctx = document.getElementById('waveErrorChart');

    if (waveErrorChart) {
        waveErrorChart.destroy();
    }

    waveErrorChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: '72h Error',
                    data: data.points_72h || [],
                    backgroundColor: 'rgba(13, 110, 253, 0.5)',
                    borderColor: '#0d6efd',
                    pointRadius: 5
                },
                {
                    label: '120h Error',
                    data: data.points_120h || [],
                    backgroundColor: 'rgba(255, 193, 7, 0.5)',
                    borderColor: '#ffc107',
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Wave ${context.parsed.x}: ±${context.parsed.y.toFixed(1)}°F error`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Wave Number' },
                    min: 0,
                    max: 10
                },
                y: {
                    title: { display: true, text: 'Temperature MAE (°F)' },
                    beginAtZero: true
                }
            }
        }
    });
}

function renderAmplitudeErrorChart(data) {
    const ctx = document.getElementById('amplitudeErrorChart');

    if (amplitudeErrorChart) {
        amplitudeErrorChart.destroy();
    }

    amplitudeErrorChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: '72h Error',
                    data: data.points_72h || [],
                    backgroundColor: 'rgba(13, 110, 253, 0.5)',
                    borderColor: '#0d6efd',
                    pointRadius: 5
                },
                {
                    label: '120h Error',
                    data: data.points_120h || [],
                    backgroundColor: 'rgba(255, 193, 7, 0.5)',
                    borderColor: '#ffc107',
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Amplitude ${context.parsed.x.toFixed(0)}m: ±${context.parsed.y.toFixed(1)}°F error`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Wave Amplitude (meters)' },
                    beginAtZero: true
                },
                y: {
                    title: { display: true, text: 'Temperature MAE (°F)' },
                    beginAtZero: true
                }
            }
        }
    });
}
</script>
{% endblock %}
