{% extends "base.html" %}

{% block title %}Rossby Wave Analysis{% endblock %}

{% block extra_css %}
<style>
    .som-grid {
        display: grid;
        gap: 6px;
    }
    .som-cell {
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 8px;
        background: #f8fafc;
        min-height: 64px;
    }
    .som-cell .som-title {
        font-size: 0.75rem;
        font-weight: 600;
        color: #334155;
    }
    .som-cell .som-metric {
        font-size: 0.85rem;
        font-weight: 600;
        color: #0f172a;
    }
    .som-cell .som-sub {
        font-size: 0.75rem;
        color: #475569;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="mb-4">
        <i class="bi bi-wind"></i> Rossby Wave Analysis
    </h1>

    <!-- Current Wave State Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-broadcast"></i> Current Wave State (500 hPa, 55°N)
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-md-4">
                            <h5>GFS</h5>
                            <div class="display-4 text-primary" id="gfs-wave-number">-</div>
                            <small class="text-muted">waves</small>
                            <div class="mt-2">
                                <small id="gfs-wave-detail" class="text-muted"></small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>AIFS</h5>
                            <div class="display-4 text-warning" id="aifs-wave-number">-</div>
                            <small class="text-muted">waves</small>
                            <div class="mt-2">
                                <small id="aifs-wave-detail" class="text-muted"></small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <h5>IFS</h5>
                            <div class="display-4 text-success" id="ifs-wave-number">-</div>
                            <small class="text-muted">waves</small>
                            <div class="mt-2">
                                <small id="ifs-wave-detail" class="text-muted"></small>
                            </div>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <strong>Method:</strong> Wave numbers calculated using spectral decomposition (Blackmon et al., 1984; Branstator, 1987).
                        Lower wave numbers (2-4) indicate larger, more persistent patterns with better forecast reliability.
                        Higher wave numbers (5-8+) suggest faster-evolving, more chaotic patterns with reduced predictability.
                        Amplitude shows the strength of the dominant wave pattern in meters, while variance indicates the percentage of height variability explained by that wave.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Wave Forecast & History Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <span><i class="bi bi-graph-up"></i> Wave Number Forecast & History</span>
                    <select class="form-select form-select-sm" id="waveHistoryDays" style="width: auto;">
                        <option value="7">1 week history</option>
                        <option value="14">2 weeks history</option>
                        <option value="30" selected>1 month history</option>
                        <option value="60">2 months history</option>
                        <option value="90">3 months history</option>
                    </select>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="position: relative; height: 400px;">
                        <canvas id="waveChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Predictability Analysis Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-graph-down"></i> Predictability Analysis
                </div>
                <div class="card-body">
                    <!-- Predictability Indicator -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Current Predictability</h6>
                                    <div class="display-4" id="predictability-status">-</div>
                                    <small class="text-muted" id="predictability-detail">Loading...</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Expected 72h Temp Error</h6>
                                    <div class="display-4 text-primary" id="expected-error-72h">-</div>
                                    <small class="text-muted">Based on current wave pattern</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-0 bg-light">
                                <div class="card-body text-center">
                                    <h6 class="text-muted mb-2">Expected 120h Temp Error</h6>
                                    <div class="display-4 text-warning" id="expected-error-120h">-</div>
                                    <small class="text-muted">Based on current wave pattern</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>About Predictability Analysis:</strong> This analysis correlates historical Rossby wave patterns
                        with forecast errors to provide uncertainty estimates. Certain wave configurations (e.g., high wave numbers,
                        large amplitudes, rapid transitions) are associated with degraded forecast skill. This gives you context
                        about how much to trust extended forecasts based on current atmospheric flow regime.
                    </div>

                    <!-- Wave Number vs Error Correlation Chart -->
                    <div class="mt-4">
                        <h6>Wave Number vs Forecast Error (Last 90 Days)</h6>
                        <div class="chart-container" style="position: relative; height: 350px;">
                            <canvas id="waveErrorChart"></canvas>
                        </div>
                    </div>

                    <!-- Amplitude vs Error Correlation Chart -->
                    <div class="mt-4">
                        <h6>Wave Amplitude vs Forecast Error (Last 90 Days)</h6>
                        <div class="chart-container" style="position: relative; height: 350px;">
                            <canvas id="amplitudeErrorChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SOM Pattern Skill Card -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <span><i class="bi bi-grid-3x3-gap"></i> SOM Pattern Skill (ERA5 Z500)</span>
                    <div class="d-flex align-items-center gap-2">
                        <label for="somGridVariable" class="small text-muted mb-0">Variable:</label>
                        <select class="form-select form-select-sm" id="somGridVariable" style="width: auto;">
                            <option value="precip" selected>Precip</option>
                            <option value="temp">Temp</option>
                        </select>
                        <label for="somLeadTime" class="small text-muted mb-0">Lead time:</label>
                        <select class="form-select form-select-sm" id="somLeadTime" style="width: auto;">
                            <option value="24">24h</option>
                            <option value="48">48h</option>
                            <option value="72" selected>72h</option>
                            <option value="120">120h</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-muted small mb-2">
                        <i class="bi bi-info-circle"></i>
                        Clusters past 500mb height anomalies (ERA5, last 30 years) and summarizes NWS 6-hr precip MAE/bias across ASOS stations.
                    </p>
                    <div id="som-loading" class="text-center py-4" style="display:none;">
                        <div class="spinner-border text-primary" role="status"></div>
                        <p class="mt-2 text-muted">Building SOM and computing skill...</p>
                    </div>
                    <div id="som-error" class="alert alert-warning" style="display:none;"></div>
                    <div id="som-summary" class="alert alert-info" style="display:none;"></div>
                    <div id="som-grid" class="som-grid"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- SOM Cluster Map Modal -->
    <div class="modal fade" id="somClusterModal" tabindex="-1" aria-labelledby="somClusterModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable" style="max-width: 95vw;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="somClusterModalLabel">SOM Cluster Station Bias/MAE</h5>
                    <div class="d-flex align-items-center gap-2">
                        <label for="somClusterVariable" class="small text-muted mb-0">Variable:</label>
                        <select class="form-select form-select-sm" id="somClusterVariable" style="width: auto;">
                            <option value="precip" selected>Precip</option>
                            <option value="temp">Temp</option>
                        </select>
                        <label for="somClusterMetric" class="small text-muted mb-0">Metric:</label>
                        <select class="form-select form-select-sm" id="somClusterMetric" style="width: auto;">
                            <option value="bias" selected>Bias</option>
                            <option value="mae">MAE</option>
                        </select>
                        <label class="small text-muted mb-0">Lead time:</label>
                        <div class="btn-group btn-group-sm" role="group" aria-label="Lead time navigation">
                            <button type="button" class="btn btn-outline-secondary" id="somLeadPrev">Back</button>
                            <button type="button" class="btn btn-outline-secondary" id="somLeadNext">Next</button>
                        </div>
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-2" id="somClusterModalSubtitle"></p>
                    <div>
                        <h6 class="mb-2">ASOS Station Bias/MAE Map</h6>
                        <div id="somClusterMap" style="height: 65vh; min-height: 450px; border-radius: 8px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scientific Background -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <i class="bi bi-book"></i> Scientific Background
                </div>
                <div class="card-body">
                    <h6>What are Rossby Waves?</h6>
                    <p>
                        Rossby waves are large-scale meanders in high-altitude winds (like the jet stream) caused by Earth's rotation.
                        They transfer heat and momentum across latitudes and govern weather patterns. The "wave number" indicates how many
                        complete wave patterns circle the globe at a given latitude.
                    </p>

                    <h6 class="mt-3">Why does wave number matter for forecasts?</h6>
                    <ul>
                        <li><strong>Low wave numbers (2-4):</strong> Large, slow-moving patterns. More persistent and predictable. Forecasts remain skillful for 7-10 days.</li>
                        <li><strong>Medium wave numbers (5-6):</strong> Typical synoptic patterns. Moderate predictability. Forecasts useful for 5-7 days.</li>
                        <li><strong>High wave numbers (7-9):</strong> Small, fast-evolving patterns. Less predictable. Forecast skill degrades beyond 3-5 days.</li>
                    </ul>

                    <h6 class="mt-3">Key Research</h6>
                    <ul class="mb-0">
                        <li><strong>Blackmon et al. (1984):</strong> Established spectral analysis methods for identifying planetary-scale waves in the atmosphere.</li>
                        <li><strong>Kornhuber et al. (2017, 2019):</strong> Showed that quasi-stationary wave patterns with wave numbers 6-8 are associated with persistent weather extremes and reduced forecast skill.</li>
                        <li><strong>Matsueda & Palmer (2018):</strong> Demonstrated that forecast skill depends critically on the atmospheric flow regime, with blocked patterns showing 20-30% skill reduction.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// Rossby Wave Analysis - JavaScript
// ============================================================================

let waveChart = null;
let waveErrorChart = null;
let amplitudeErrorChart = null;
let somClusterMap = null;
let somClusterMarkers = [];
let somClusterModal = null;
let somClusterStations = [];
let somClusterCurrent = { r: null, c: null, leadTime: null };

// Load all data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadWaveAnalysis();
    loadWaveChart();
    loadPredictabilityAnalysis();
    loadSomSkill();
    somClusterModal = new bootstrap.Modal(document.getElementById('somClusterModal'));
    document.getElementById('somClusterModal').addEventListener('shown.bs.modal', () => {
        if (somClusterMap) {
            setTimeout(() => somClusterMap.invalidateSize(), 50);
        }
    });
    document.getElementById('somClusterMetric').addEventListener('change', () => {
        renderSomClusterMarkers();
    });
    document.getElementById('somClusterVariable').addEventListener('change', (e) => {
        if (somClusterCurrent.r != null) {
            openSomClusterMap(
                somClusterCurrent.r,
                somClusterCurrent.c,
                somClusterCurrent.leadTime,
                e.target.value
            );
        }
    });
    document.getElementById('somLeadPrev').addEventListener('click', () => shiftSomClusterLeadTime(-1));
    document.getElementById('somLeadNext').addEventListener('click', () => shiftSomClusterLeadTime(1));
});

// Event listeners
document.getElementById('waveHistoryDays').addEventListener('change', loadWaveChart);
document.getElementById('somLeadTime').addEventListener('change', loadSomSkill);
document.getElementById('somGridVariable').addEventListener('change', loadSomSkill);
// Note: keep modal variable independent from the SOM grid selection

// ============================================================================
// Current Wave State
// ============================================================================

async function loadWaveAnalysis() {
    try {
        const response = await fetch('/api/wave-analysis?location=Fairfax,%20VA');
        const data = await response.json();

        if (!data.success) {
            console.error('Error loading wave analysis:', data.error);
            return;
        }

        // Update GFS
        if (data.gfs_waves && data.gfs_waves.wave_number !== null) {
            document.getElementById('gfs-wave-number').textContent = data.gfs_waves.wave_number;
            const amp = data.gfs_waves.top_3_amplitudes ? data.gfs_waves.top_3_amplitudes[0].toFixed(0) : 'N/A';
            const var_exp = data.gfs_waves.top_3_variance ? data.gfs_waves.top_3_variance[0].toFixed(1) : 'N/A';
            document.getElementById('gfs-wave-detail').textContent =
                `Amplitude: ${amp}m, Variance: ${var_exp}%`;
        } else {
            document.getElementById('gfs-wave-number').textContent = '-';
            document.getElementById('gfs-wave-detail').textContent = '';
        }

        // Update AIFS
        if (data.aifs_waves && data.aifs_waves.wave_number !== null) {
            document.getElementById('aifs-wave-number').textContent = data.aifs_waves.wave_number;
            const amp = data.aifs_waves.top_3_amplitudes ? data.aifs_waves.top_3_amplitudes[0].toFixed(0) : 'N/A';
            const var_exp = data.aifs_waves.top_3_variance ? data.aifs_waves.top_3_variance[0].toFixed(1) : 'N/A';
            document.getElementById('aifs-wave-detail').textContent =
                `Amplitude: ${amp}m, Variance: ${var_exp}%`;
        } else {
            document.getElementById('aifs-wave-number').textContent = '-';
            document.getElementById('aifs-wave-detail').textContent = '';
        }

        // Update IFS
        if (data.ifs_waves && data.ifs_waves.wave_number !== null) {
            document.getElementById('ifs-wave-number').textContent = data.ifs_waves.wave_number;
            const amp = data.ifs_waves.top_3_amplitudes ? data.ifs_waves.top_3_amplitudes[0].toFixed(0) : 'N/A';
            const var_exp = data.ifs_waves.top_3_variance ? data.ifs_waves.top_3_variance[0].toFixed(1) : 'N/A';
            document.getElementById('ifs-wave-detail').textContent =
                `Amplitude: ${amp}m, Variance: ${var_exp}%`;
        } else {
            document.getElementById('ifs-wave-number').textContent = '-';
            document.getElementById('ifs-wave-detail').textContent = '';
        }
    } catch (error) {
        console.error('Error loading wave analysis:', error);
    }
}

// ============================================================================
// Wave Forecast & History Chart
// ============================================================================

async function loadWaveChart() {
    const daysBack = document.getElementById('waveHistoryDays').value;

    try {
        const [historyResponse, forecastResponse] = await Promise.all([
            fetch(`/api/wave-time-series?location=Fairfax,%20VA&days_back=${daysBack}`),
            fetch('/api/wave-forecast?location=Fairfax,%20VA')
        ]);

        const historyData = await historyResponse.json();
        const forecastData = await forecastResponse.json();

        renderWaveChart(historyData, forecastData);
    } catch (error) {
        console.error('Error loading wave chart:', error);
    }
}

function renderWaveChart(historyData, forecastData) {
    const ctx = document.getElementById('waveChart');

    if (waveChart) {
        waveChart.destroy();
    }

    const datasets = [];

    // Add historical data
    if (historyData.success && historyData.dates && historyData.dates.length > 0) {
        datasets.push({
            label: 'History',
            data: historyData.gfs,
            borderColor: '#000000',
            backgroundColor: 'rgba(0, 0, 0, 0.05)',
            borderWidth: 2.5,
            tension: 0.3,
            pointRadius: 2,
            pointHoverRadius: 5,
            spanGaps: true
        });
    }

    // Add forecast data for each model
    if (forecastData.success) {
        const gfsForecast = forecastData.gfs_forecast || {};
        const aifsForecast = forecastData.aifs_forecast || {};
        const ifsForecast = forecastData.ifs_forecast || {};

        if (gfsForecast.times && gfsForecast.times.length > 0) {
            datasets.push({
                label: 'GFS Forecast',
                data: gfsForecast.wave_numbers || [],
                borderColor: '#0d6efd',
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
                spanGaps: true
            });
        }

        if (aifsForecast.wave_numbers && aifsForecast.wave_numbers.length > 0) {
            datasets.push({
                label: 'AIFS Forecast',
                data: aifsForecast.wave_numbers || [],
                borderColor: '#0dcaf0',
                backgroundColor: 'rgba(13, 202, 240, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
                spanGaps: true
            });
        }

        if (ifsForecast.wave_numbers && ifsForecast.wave_numbers.length > 0) {
            datasets.push({
                label: 'IFS Forecast',
                data: ifsForecast.wave_numbers || [],
                borderColor: '#20c997',
                backgroundColor: 'rgba(32, 201, 151, 0.1)',
                borderWidth: 2,
                tension: 0.3,
                pointRadius: 3,
                pointHoverRadius: 6,
                spanGaps: true
            });
        }
    }

    // Combine all labels
    let allLabels = [];
    if (historyData.success && historyData.dates) {
        allLabels = historyData.dates.map(d => new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
    }
    if (forecastData.success && forecastData.gfs_forecast && forecastData.gfs_forecast.times) {
        const forecastLabels = forecastData.gfs_forecast.times.map(t => new Date(t).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        allLabels = allLabels.concat(forecastLabels);
    }

    // Pad datasets
    const historyLength = historyData.success && historyData.dates ? historyData.dates.length : 0;
    datasets.forEach(dataset => {
        if (dataset.label !== 'History') {
            const forecastData = dataset.data.filter(d => d !== null);
            dataset.data = Array(historyLength).fill(null).concat(forecastData);
        }
    });

    waveChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: allLabels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: { usePointStyle: true, padding: 15 }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) label += ': ';
                            if (context.parsed.y !== null) {
                                label += context.parsed.y.toFixed(1) + ' waves';
                            }
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    grid: { color: '#e0e0e0' },
                    title: { display: true, text: 'Wave Number' },
                    min: 0,
                    max: 10,
                    ticks: { stepSize: 1 }
                },
                x: {
                    grid: { color: '#f0f0f0' },
                    ticks: { maxRotation: 45, minRotation: 45 }
                }
            }
        }
    });
}

// ============================================================================
// Predictability Analysis
// ============================================================================

async function loadPredictabilityAnalysis() {
    try {
        const response = await fetch('/api/wave-skill-correlation?location=Fairfax,%20VA');
        const data = await response.json();

        if (!data.success) {
            console.error('Error loading predictability analysis:', data.error);
            document.getElementById('predictability-status').textContent = 'N/A';
            document.getElementById('predictability-detail').textContent = 'Data not available';
            document.getElementById('expected-error-72h').textContent = '-';
            document.getElementById('expected-error-120h').textContent = '-';
            return;
        }

        // Update predictability status
        const currentWave = data.current_wave_number || 0;
        const status = data.predictability_status || 'Unknown';
        const confidence = data.confidence || 'Low';

        document.getElementById('predictability-status').textContent = status;
        document.getElementById('predictability-status').className = 'display-4 ' +
            (status === 'HIGH' ? 'text-success' : status === 'MEDIUM' ? 'text-warning' : 'text-danger');
        document.getElementById('predictability-detail').textContent =
            `Wave ${currentWave} | Confidence: ${confidence}`;

        // Update expected errors
        const error72h = data.expected_error_72h || 0;
        const error120h = data.expected_error_120h || 0;
        document.getElementById('expected-error-72h').textContent = error72h > 0 ? `±${error72h.toFixed(1)}°F` : '-';
        document.getElementById('expected-error-120h').textContent = error120h > 0 ? `±${error120h.toFixed(1)}°F` : '-';

        // Render correlation charts
        if (data.wave_error_correlation) {
            renderWaveErrorChart(data.wave_error_correlation);
        }
        if (data.amplitude_error_correlation) {
            renderAmplitudeErrorChart(data.amplitude_error_correlation);
        }

    } catch (error) {
        console.error('Error loading predictability analysis:', error);
    }
}

function renderWaveErrorChart(data) {
    const ctx = document.getElementById('waveErrorChart');

    if (waveErrorChart) {
        waveErrorChart.destroy();
    }

    waveErrorChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: '72h Error',
                    data: data.points_72h || [],
                    backgroundColor: 'rgba(13, 110, 253, 0.5)',
                    borderColor: '#0d6efd',
                    pointRadius: 5
                },
                {
                    label: '120h Error',
                    data: data.points_120h || [],
                    backgroundColor: 'rgba(255, 193, 7, 0.5)',
                    borderColor: '#ffc107',
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Wave ${context.parsed.x}: ±${context.parsed.y.toFixed(1)}°F error`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Wave Number' },
                    min: 0,
                    max: 10
                },
                y: {
                    title: { display: true, text: 'Temperature MAE (°F)' },
                    beginAtZero: true
                }
            }
        }
    });
}

function renderAmplitudeErrorChart(data) {
    const ctx = document.getElementById('amplitudeErrorChart');

    if (amplitudeErrorChart) {
        amplitudeErrorChart.destroy();
    }

    amplitudeErrorChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [
                {
                    label: '72h Error',
                    data: data.points_72h || [],
                    backgroundColor: 'rgba(13, 110, 253, 0.5)',
                    borderColor: '#0d6efd',
                    pointRadius: 5
                },
                {
                    label: '120h Error',
                    data: data.points_120h || [],
                    backgroundColor: 'rgba(255, 193, 7, 0.5)',
                    borderColor: '#ffc107',
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'top' },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Amplitude ${context.parsed.x.toFixed(0)}m: ±${context.parsed.y.toFixed(1)}°F error`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Wave Amplitude (meters)' },
                    beginAtZero: true
                },
                y: {
                    title: { display: true, text: 'Temperature MAE (°F)' },
                    beginAtZero: true
                }
            }
        }
    });
}

// ============================================================================
// SOM Pattern Skill
// ============================================================================

async function loadSomSkill() {
    const leadTime = document.getElementById('somLeadTime').value;
    const gridVariable = document.getElementById('somGridVariable').value;
    const loading = document.getElementById('som-loading');
    const errorDiv = document.getElementById('som-error');
    const summaryDiv = document.getElementById('som-summary');
    const grid = document.getElementById('som-grid');

    loading.style.display = 'block';
    errorDiv.style.display = 'none';
    summaryDiv.style.display = 'none';
    grid.innerHTML = '';

    try {
        const response = await fetch(`/api/era5/som-skill?lead_time=${leadTime}&variable=${gridVariable}`);
        const data = await response.json();

        loading.style.display = 'none';

        if (!data.success) {
            errorDiv.textContent = data.error || 'Error loading SOM data';
            errorDiv.style.display = 'block';
            return;
        }

        const rows = data.rows;
        const cols = data.cols;
        const nodes = data.nodes || [];

        const maeValues = nodes.filter(n => n.mae_mean !== null).map(n => n.mae_mean);
        const minMae = maeValues.length ? Math.min(...maeValues) : 0;
        const maxMae = maeValues.length ? Math.max(...maeValues) : 1;

        grid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

        function colorForMae(value) {
            if (value === null || value === undefined) return '#f1f5f9';
            const maxMae = (gridVariable === 'temp') ? 10 : 1;
            const t = Math.max(0, Math.min(1, value / maxMae));
            // Green -> Yellow -> Orange -> Red
            if (t < 0.33) return '#86efac';   // light green
            if (t < 0.66) return '#facc15';   // yellow
            if (t < 0.85) return '#fb923c';   // orange
            return '#ef4444';                 // red
        }

        const isCurrent = (node) => (
            data.latest_gfs_cluster &&
            node.r === data.latest_gfs_cluster[0] &&
            node.c === data.latest_gfs_cluster[1]
        );

        nodes.forEach(node => {
            const cell = document.createElement('div');
            cell.className = 'som-cell';
            cell.style.background = colorForMae(node.mae_mean);
            if (isCurrent(node)) {
                cell.style.outline = '3px solid #1d4ed8';
                cell.style.boxShadow = '0 0 0 2px rgba(29, 78, 216, 0.15)';
            }
            cell.style.cursor = 'pointer';

            const title = document.createElement('div');
            title.className = 'som-title';
            title.textContent = `C${node.r + 1}-${node.c + 1}` + (isCurrent(node) ? ' • Current' : '');

            const metric = document.createElement('div');
            metric.className = 'som-metric';
            const mae = node.mae_mean;
            const bias = node.bias_mean;
            const runCount = node.runs ?? 0;
            metric.textContent = mae !== null && mae !== undefined
                ? `MAE ${gridVariable === 'temp' ? mae.toFixed(1) + '°F' : mae.toFixed(2) + '\"'}`
                : 'MAE N/A';

            const sub = document.createElement('div');
            sub.className = 'som-sub';
            if (bias !== null && bias !== undefined) {
                const sign = bias > 0 ? '+' : '';
                const biasText = gridVariable === 'temp' ? `${sign}${bias.toFixed(1)}°F` : `${sign}${bias.toFixed(2)}\"`;
                sub.textContent = `Bias ${biasText}`;
            } else {
                sub.textContent = 'Bias N/A';
            }

            const countLine = document.createElement('div');
            countLine.className = 'som-sub';
            countLine.textContent = `runs=${runCount}`;

            cell.appendChild(title);
            cell.appendChild(metric);
            cell.appendChild(sub);
            cell.appendChild(countLine);
            grid.appendChild(cell);

            cell.addEventListener('click', () => {
                const gridVar = document.getElementById('somGridVariable').value;
                openSomClusterMap(node.r, node.c, leadTime, gridVar);
            });
        });

        const ranked = nodes.filter(n => n.mae_mean !== null).sort((a, b) => a.mae_mean - b.mae_mean);
        const best = ranked.slice(0, 3);
        const worst = ranked.slice(-3).reverse();

        const bestStr = best.map(n => `C${n.r + 1}-${n.c + 1} (${gridVariable === 'temp' ? n.mae_mean.toFixed(1) + '°F' : n.mae_mean.toFixed(2) + '\"'})`).join(', ');
        const worstStr = worst.map(n => `C${n.r + 1}-${n.c + 1} (${gridVariable === 'temp' ? n.mae_mean.toFixed(1) + '°F' : n.mae_mean.toFixed(2) + '\"'})`).join(', ');

        const latest = data.latest_gfs_cluster
            ? `Latest GFS pattern: C${data.latest_gfs_cluster[0] + 1}-${data.latest_gfs_cluster[1] + 1} on ${data.latest_gfs_date}`
            : (data.latest_cluster ? `Latest ERA5 pattern: C${data.latest_cluster[0] + 1}-${data.latest_cluster[1] + 1} on ${data.latest_date}` : 'Latest pattern: N/A');

        summaryDiv.innerHTML = `
            <strong>Best patterns:</strong> ${bestStr || 'N/A'}<br>
            <strong>Worst patterns:</strong> ${worstStr || 'N/A'}<br>
            <strong>${latest}</strong>
        `;
        summaryDiv.style.display = 'block';

    } catch (error) {
        loading.style.display = 'none';
        errorDiv.textContent = 'Error loading SOM data: ' + error;
        errorDiv.style.display = 'block';
    }
}

function initSomClusterMap() {
    if (somClusterMap) return;
    somClusterMap = L.map('somClusterMap', {
        zoomControl: true,
        scrollWheelZoom: true
    }).setView([39.8283, -98.5795], 4);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(somClusterMap);
}

function clearSomClusterMarkers() {
    somClusterMarkers.forEach(m => somClusterMap.removeLayer(m));
    somClusterMarkers = [];
}

function getSomLeadTimes() {
    const select = document.getElementById('somLeadTime');
    if (!select) return [24, 48, 72, 120];
    return Array.from(select.options)
        .map(opt => parseInt(opt.value, 10))
        .filter(v => !Number.isNaN(v));
}

function shiftSomClusterLeadTime(delta) {
    if (somClusterCurrent.r == null) return;
    const leadTimes = getSomLeadTimes();
    const currentIdx = leadTimes.indexOf(parseInt(somClusterCurrent.leadTime, 10));
    if (currentIdx === -1) return;
    const nextIdx = Math.max(0, Math.min(leadTimes.length - 1, currentIdx + delta));
    if (nextIdx === currentIdx) return;
    const variable = document.getElementById('somClusterVariable')?.value || null;
    openSomClusterMap(somClusterCurrent.r, somClusterCurrent.c, leadTimes[nextIdx], variable);
}

async function openSomClusterMap(r, c, leadTime, variableOverride = null) {
    const subtitle = document.getElementById('somClusterModalSubtitle');
    const gridVariable = document.getElementById('somGridVariable').value;
    const modalVarSelect = document.getElementById('somClusterVariable');
    const variable = variableOverride || (modalVarSelect ? modalVarSelect.value : null) || gridVariable;
    if (modalVarSelect) {
        modalVarSelect.value = variable;
    }
    subtitle.textContent = `Cluster C${r + 1}-${c + 1} | Lead time ${leadTime}h | NWS ${variable} bias (color) & MAE (size)`;
    somClusterCurrent = { r, c, leadTime };

    initSomClusterMap();
    clearSomClusterMarkers();
    somClusterModal.show();
    setTimeout(() => {
        if (somClusterMap) {
            somClusterMap.setView([39.8283, -98.5795], 4);
            somClusterMap.invalidateSize();
        }
    }, 150);

    try {
        const stationsResp = await fetch(`/api/era5/som-cluster-stations?cluster=${r},${c}&lead_time=${leadTime}&variable=${variable}`);
        const data = await stationsResp.json();
        if (!data.success) {
            subtitle.textContent = `Cluster C${r + 1}-${c + 1} | Error: ${data.error || 'failed to load'}`;
            return;
        }

        somClusterStations = data.stations;
        renderSomClusterMarkers();
        if (!data.stations || data.stations.length === 0) {
            subtitle.textContent = `Cluster C${r + 1}-${c + 1} | No station data yet for ${leadTime}h (${variable})`;
        }

    } catch (error) {
        subtitle.textContent = `Cluster C${r + 1}-${c + 1} | Error: ${error}`;
    }
}

function getMaeColor(value, variable) {
    const fixedMin = 0;
    const fixedMax = (variable === 'precip') ? 1 : 10;
    const ratio = Math.max(0, Math.min(1, (value - fixedMin) / (fixedMax - fixedMin)));

    if (ratio < 0.5) {
        const t = ratio * 2;
        const r = Math.round(34 + t * (234 - 34));
        const g = Math.round(197 + t * (179 - 197));
        const b = Math.round(94 + t * (8 - 94));
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        const t = (ratio - 0.5) * 2;
        const r = Math.round(234 + t * (239 - 234));
        const g = Math.round(179 + t * (68 - 179));
        const b = Math.round(8 + t * (68 - 8));
        return `rgb(${r}, ${g}, ${b})`;
    }
}

function getBiasColor(value, variable) {
    const fixedMax = (variable === 'precip') ? 1 : 10;
    const fixedMin = -fixedMax;
    const clampedValue = Math.max(fixedMin, Math.min(fixedMax, value));
    const ratio = clampedValue / fixedMax;  // -1 to 1
    if (variable === 'precip') {
        const gradientRatio = (ratio + 1) / 2;  // 0 to 1
        if (gradientRatio < 0.5) {
            const t = gradientRatio * 2;
            const r = Math.round(139 + t * (255 - 139));
            const g = Math.round(69 + t * (255 - 69));
            const b = Math.round(19 + t * (255 - 19));
            return `rgb(${r}, ${g}, ${b})`;
        } else {
            const t = (gradientRatio - 0.5) * 2;
            const r = Math.round(255 - t * (255 - 34));
            const g = Math.round(255 - t * (255 - 139));
            const b = Math.round(255 - t * (255 - 34));
            return `rgb(${r}, ${g}, ${b})`;
        }
    }
    if (ratio < 0) {
        const t = 1 + ratio;  // 0 to 1
        const r = Math.round(59 + t * (255 - 59));
        const g = Math.round(130 + t * (255 - 130));
        const b = Math.round(246 + t * (255 - 246));
        return `rgb(${r}, ${g}, ${b})`;
    } else {
        const t = ratio;  // 0 to 1
        const r = Math.round(255 + t * (239 - 255));
        const g = Math.round(255 + t * (68 - 255));
        const b = Math.round(255 + t * (68 - 255));
        return `rgb(${r}, ${g}, ${b})`;
    }
}

function getMarkerColor(value, metric, variable) {
    return metric === 'bias' ? getBiasColor(value, variable) : getMaeColor(value, variable);
}

function radiusForMetric(value, metric, variable) {
    const maxScale = (variable === 'precip') ? 1 : 10;
    if (metric === 'bias') {
        const absValue = Math.abs(value);
        const normalized = Math.min(absValue / maxScale, 1);
        return 3 + normalized * 4.5;
    } else {
        const normalized = Math.min(value / maxScale, 1);
        return 3 + normalized * 4.5;
    }
}

function renderSomClusterMarkers() {
    if (!somClusterMap) return;
    clearSomClusterMarkers();

    const metric = document.getElementById('somClusterMetric').value;
    const variable = document.getElementById('somClusterVariable').value;
    const subtitle = document.getElementById('somClusterModalSubtitle');
    if (somClusterCurrent.r !== null) {
        subtitle.textContent = `Cluster C${somClusterCurrent.r + 1}-${somClusterCurrent.c + 1} | Lead time ${somClusterCurrent.leadTime}h | NWS ${variable} ${metric.toUpperCase()} (color + size)`;
    }

    somClusterStations.forEach(s => {
        if (s.lat == null || s.lon == null) return;
        const value = metric === 'bias' ? s.bias : s.mae;
        if (value == null) return;

        const marker = L.circleMarker([s.lat, s.lon], {
            radius: radiusForMetric(value, metric, variable),
            fillColor: getMarkerColor(value, metric, variable),
            color: '#333',
            weight: 1,
            opacity: 0.8,
            fillOpacity: 0.9
        }).addTo(somClusterMap);

        marker.bindTooltip(
            `<strong>${s.station_id}</strong> ${s.name || ''}<br>` +
                `MAE: ${s.mae.toFixed(2)}${variable === 'temp' ? '°F' : '\"'}<br>` +
                `Bias: ${s.bias > 0 ? '+' : ''}${s.bias.toFixed(2)}${variable === 'temp' ? '°F' : '\"'}<br>` +
                `n=${s.count}`
        );
        somClusterMarkers.push(marker);
    });
}
</script>
{% endblock %}
