{% extends "base.html" %}

{% block title %}Historical Weather - Weather Forecast{% endblock %}

{% block extra_css %}
<style>
    .historical-tabs {
        margin-bottom: 1rem;
    }

    .nav-tabs .nav-link {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="forecast-header">
    <div class="row align-items-center">
        <div class="col-12">
            <h1 class="mb-1"><i class="bi bi-clock-history"></i> Historical Weather</h1>
            <p class="mb-0 opacity-75">Historical observations and climatology</p>
        </div>
    </div>
</div>

<ul class="nav nav-tabs historical-tabs" id="historicalTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="fairfax-tab" data-bs-toggle="tab" data-bs-target="#fairfaxPane" type="button" role="tab" aria-controls="fairfaxPane" aria-selected="true">
            Fairfax Station
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="era-tab" data-bs-toggle="tab" data-bs-target="#eraPane" type="button" role="tab" aria-controls="eraPane" aria-selected="false">
            ERA Reanalysis
        </button>
    </li>
</ul>

<div class="tab-content" id="historicalContent">
    <div class="tab-pane fade show active" id="fairfaxPane" role="tabpanel" aria-labelledby="fairfax-tab">
<!-- Date Range Picker Card -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-3 mb-2">
                <label for="start-date" class="form-label">Start Date</label>
                <input type="date" class="form-control" id="start-date" value="{{ start_date }}">
            </div>
            <div class="col-md-3 mb-2">
                <label for="end-date" class="form-label">End Date</label>
                <input type="date" class="form-control" id="end-date" value="{{ end_date }}">
            </div>
            <div class="col-md-4 mb-2">
                <label class="form-label">Quick Select</label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-secondary" onclick="setDateRange(7)">7 Days</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setDateRange(30)">30 Days</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setDateRange(90)">90 Days</button>
                    <button type="button" class="btn btn-outline-secondary" onclick="setYTD()">YTD</button>
                </div>
            </div>
            <div class="col-md-2 mb-2">
                <button class="btn btn-primary w-100" onclick="loadData()">
                    <i class="bi bi-search"></i> Load Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Summary Stats -->
<div class="row mb-4" id="summary-section">
    <div class="col-md-3 col-6 mb-3">
        <div class="card h-100">
            <div class="stat-card">
                <div class="stat-label">Temperature Range</div>
                <div class="stat-value temp" style="font-size: 1.5rem;">
                    <span id="temp-min">{{ summary.temp_min if summary.temp_min else '--' }}</span> -
                    <span id="temp-max">{{ summary.temp_max if summary.temp_max else '--' }}</span><span class="stat-unit">&deg;F</span>
                </div>
                <div class="text-muted small">
                    Avg: <span id="temp-avg">{{ summary.temp_avg if summary.temp_avg else '--' }}</span>&deg;F
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card h-100">
            <div class="stat-card">
                <div class="stat-label">Total Rainfall</div>
                <div class="stat-value rain" id="rain-total">
                    {{ summary.rain_total if summary.rain_total else '0' }}<span class="stat-unit"> in</span>
                </div>
                <div class="text-muted small">
                    <span id="rainy-days">{{ summary.rainy_days if summary.rainy_days else '0' }}</span> rainy days
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card h-100">
            <div class="stat-card">
                <div class="stat-label">Avg Solar Radiation (daylight)</div>
                <div class="stat-value sun" id="solar-avg">
                    {{ summary.solar_rad_avg|int if summary.solar_rad_avg else '--' }}<span class="stat-unit"> W/m&sup2;</span>
                </div>
                <div class="text-muted small">
                    Normal: <span id="solar-historical">{{ summary.solar_rad_historical|int if summary.solar_rad_historical else '--' }}</span> W/m&sup2;
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-6 mb-3">
        <div class="card h-100">
            <div class="stat-card">
                <div class="stat-label">Avg Gust / Max Gust</div>
                <div class="stat-value" id="wind-avg">
                    {{ summary.wind_gust_avg if summary.wind_gust_avg else '--' }}<span class="stat-unit"> / </span><span id="wind-gust-max">{{ summary.wind_gust_max if summary.wind_gust_max else '--' }}</span><span class="stat-unit"> mph</span>
                </div>
                <div class="text-muted small">
                    Normal avg gust: <span id="wind-gust-historical">{{ summary.wind_gust_historical if summary.wind_gust_historical else '--' }}</span> mph
                </div>
                <div class="text-muted small">
                    <span id="days-count">{{ summary.days if summary.days else '0' }}</span> days of data
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Charts -->
<div class="row">
    <!-- Temperature Chart with Climatology -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-thermometer-half"></i> Temperature vs. Historical (Dulles IAD 1990-2021)
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Temperature Anomalies Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up-arrow"></i> Temperature Anomalies (Departure from Normal)
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="anomalyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Rainfall Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-cloud-rain"></i> Daily Rainfall
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="rainChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Soil Temperature Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-thermometer"></i> Soil Temperature
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="soilTempChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Soil Moisture Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-moisture"></i> Soil Moisture
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="soilMoistureChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Solar Radiation Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-sun"></i> Solar Radiation
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="solarChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Wind Speed Chart -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-wind"></i> Wind Speed
            </div>
            <div class="card-body">
                <div class="chart-container">
                    <canvas id="windChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
    </div><!-- End Fairfax Station tab -->

    <div class="tab-pane fade" id="eraPane" role="tabpanel" aria-labelledby="era-tab">
        <!-- ERA Subtabs -->
        <ul class="nav nav-tabs mb-3" id="eraSubTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="era-500mb-tab" data-bs-toggle="tab" data-bs-target="#era500mbPane" type="button" role="tab" aria-controls="era500mbPane" aria-selected="true">
                    500mb Heights
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="conus-analogs-tab" data-bs-toggle="tab" data-bs-target="#conusAnalogsPane" type="button" role="tab" aria-controls="conusAnalogsPane" aria-selected="false">
                    CONUS Analogs
                </button>
            </li>
        </ul>

        <div class="tab-content" id="eraSubContent">
            <div class="tab-pane fade show active" id="era500mbPane" role="tabpanel" aria-labelledby="era-500mb-tab">
                <!-- Date Selector -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="era-start-date" class="form-label">Start Date</label>
                                <input type="date" class="form-control" id="era-start-date">
                            </div>
                            <div class="col-md-3">
                                <label for="era-end-date" class="form-label">End Date</label>
                                <input type="date" class="form-control" id="era-end-date">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Quick Select</label>
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setEraDateRange(30)">30 Days</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setEraDateRange(90)">90 Days</button>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setEraDateRange(365)">1 Year</button>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <button class="btn btn-primary w-100" onclick="loadEraData()">
                                    <i class="bi bi-search"></i> Load ERA5 Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Rossby Wave Analysis -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> ERA5 Rossby Wave Analysis (1940-Present)
                    </div>
                    <div class="card-body">
                        <div id="era-wave-loading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Loading ERA5 data...</p>
                        </div>
                        <div id="era-wave-error" class="alert alert-warning" style="display: none;"></div>
                        <div class="chart-container">
                            <canvas id="eraWaveChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Analog Forecast -->
                <div class="card mb-4">
                    <div class="card-header">
                        <i class="bi bi-layers"></i> Historical Analogs (Pattern Matching)
                    </div>
                    <div class="card-body">
                        <div id="analog-loading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Finding similar patterns...</p>
                        </div>
                        <div id="analog-error" class="alert alert-warning" style="display: none;"></div>
                        <div id="analog-content">
                            <div class="mb-3">
                                <strong>Current Pattern:</strong> <span id="analog-current-date">--</span>
                                <small class="text-muted ms-2">(Latest 00Z forecast initialization)</small>
                            </div>
                            <div class="mb-3 d-flex align-items-end gap-3 flex-wrap">
                                <div>
                                    <label class="form-label">Number of analogs:</label>
                                    <select class="form-select form-select-sm" id="analog-count" style="width: auto;">
                                        <option value="5">Top 5</option>
                                        <option value="10" selected>Top 10</option>
                                        <option value="20">Top 20</option>
                                        <option value="50">Top 50</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Scoring method:</label>
                                    <select class="form-select form-select-sm" id="analog-method" style="width: auto;">
                                        <option value="composite" selected>Composite (recommended)</option>
                                        <option value="lat_pearson">Lat-weighted Pearson</option>
                                        <option value="pearson">Legacy Pearson</option>
                                    </select>
                                </div>
                            </div>
                            <button class="btn btn-primary" onclick="loadAnalogs()">
                                <i class="bi bi-search"></i> Find Analogs
                            </button>
                            <div id="analog-results" class="mt-4" style="display: none;">
                                <p class="text-muted small mb-3">
                                    <i class="bi bi-info-circle"></i> Values shown are averaged over the 2-week period following each analog pattern match
                                </p>
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <div class="alert alert-success mb-0">
                                            <strong>Analog precip:</strong><br>
                                            <small class="text-muted">Following 14 days</small><br>
                                            <span id="analog-avg-precip" class="fs-4">--</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="alert alert-secondary mb-0">
                                            <strong>Normal precip:</strong><br>
                                            <small class="text-muted">Following 14 days</small><br>
                                            <span id="analog-climatology-precip" class="fs-4">--</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="alert alert-warning mb-0">
                                            <strong>Analog temp:</strong><br>
                                            <small class="text-muted">Following 14 days</small><br>
                                            <span id="analog-avg-temp" class="fs-4">--</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="alert alert-secondary mb-0">
                                            <strong>Normal temp:</strong><br>
                                            <small class="text-muted">Following 14 days</small><br>
                                            <span id="analog-climatology-temp" class="fs-4">--</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div id="analog-precip-comparison" class="alert" style="display: none;">
                                            <strong>Precipitation:</strong> <span id="analog-precip-comparison-text"></span>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="analog-temp-comparison" class="alert" style="display: none;">
                                            <strong>Temperature:</strong> <span id="analog-temp-comparison-text"></span>
                                        </div>
                                    </div>
                                </div>
                                <h6>Most Similar Historical Dates: <small class="text-muted fw-normal">click a date to compare its 500mb pattern vs. today's GFS</small></h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>Rank</th>
                                                <th>Date</th>
                                                <th>Score</th>
                                                <th title="Latitude-weighted spatial Pearson correlation of z500 anomalies">Pattern</th>
                                                <th title="Spatial gradient field correlation – captures ridge/trough positions">Circulation</th>
                                                <th>Wave #</th>
                                                <th>14-Day Precip</th>
                                                <th>14-Day Avg Temp</th>
                                                <th>Days Ago</th>
                                            </tr>
                                        </thead>
                                        <tbody id="analog-table-body">
                                        </tbody>
                                    </table>
                                </div>

                                <!-- Pattern comparison card (shown on date click) -->
                                <div id="analog-compare-card" class="card mt-3" style="display:none;">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <span><i class="bi bi-map"></i> Pattern Comparison: <span id="analog-compare-title" class="fw-semibold">--</span></span>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="closeAnalogCompare()"><i class="bi bi-x"></i></button>
                                    </div>
                                    <div class="card-body">
                                        <div id="analog-compare-loading" class="text-center py-4" style="display:none;">
                                            <div class="spinner-border text-primary" role="status"></div>
                                            <p class="mt-2 text-muted">Fetching ERA5 &amp; live GFS data…</p>
                                        </div>
                                        <div id="analog-compare-error" class="alert alert-warning" style="display:none;"></div>
                                        <div id="analog-compare-img-wrap" style="display:none; text-align:center;">
                                            <img id="analog-compare-img" src="" alt="Pattern comparison" style="max-width:100%; border-radius:8px;">
                                            <p class="text-muted small mt-2" id="analog-compare-caption"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info mt-3 mb-0">
                                <strong>About Analog Forecasting:</strong> This tool finds historical dates with similar 500mb height patterns
                                to the current forecast. Similar patterns often lead to similar weather outcomes. The <strong>Composite</strong>
                                method combines area-weighted pattern correlation (<em>Pattern</em>), gradient-field correlation (<em>Circulation</em>),
                                and amplitude similarity — giving a more physically meaningful match than plain Pearson.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analog Prediction History Chart -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-graph-up"></i> Analog Forecast History
                        <small class="text-muted ms-2">Track predictions and pattern similarity over time</small>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-2">
                            <i class="bi bi-info-circle"></i> Hover over chart to see pattern similarity (correlation strength) for each prediction
                        </p>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="analogHistoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- 500mb Height Map -->
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-map"></i> 500mb Geopotential Height Map
                        <span id="map-date-display" class="badge bg-secondary ms-2"></span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="map-date-select" class="form-label">Select Date:</label>
                            <div class="input-group">
                                <button class="btn btn-outline-secondary" onclick="navigateMapDate('first')" title="First Available">
                                    <i class="bi bi-skip-start-fill"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="navigateMapDate('prev')" title="Previous Day">
                                    <i class="bi bi-caret-left-fill"></i>
                                </button>
                                <input type="date" class="form-control" id="map-date-select" onchange="loadHeightMap()">
                                <button class="btn btn-outline-secondary" onclick="navigateMapDate('next')" title="Next Day">
                                    <i class="bi bi-caret-right-fill"></i>
                                </button>
                                <button class="btn btn-outline-secondary" onclick="navigateMapDate('last')" title="Most Recent">
                                    <i class="bi bi-skip-end-fill"></i>
                                </button>
                            </div>
                        </div>
                        <div id="height-map-loading" class="text-center py-5" style="display: none;">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="mt-2">Generating map...</p>
                        </div>
                        <div id="height-map-container" style="min-height: 500px; text-align: center;">
                            <div class="text-muted">
                                <i class="bi bi-map" style="font-size: 4rem; opacity: 0.3;"></i>
                                <p class="mt-3">Select a date to view 500mb height map</p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <strong>Wave Analysis:</strong>
                                <span id="map-wave-info">Select a date to view wave analysis</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div><!-- End 500mb Heights subtab -->

            <!-- CONUS Analogs subtab -->
            <div class="tab-pane fade" id="conusAnalogsPane" role="tabpanel" aria-labelledby="conus-analogs-tab">
                <!-- Control Panel -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label for="conus-analog-count" class="form-label">Number of Analogs</label>
                                <select class="form-select" id="conus-analog-count">
                                    <option value="5">Top 5</option>
                                    <option value="10" selected>Top 10</option>
                                    <option value="20">Top 20</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="conus-analog-variable" class="form-label">Variable</label>
                                <select class="form-select" id="conus-analog-variable">
                                    <option value="precip" selected>Precipitation</option>
                                    <option value="temp">Temperature</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button id="load-conus-analogs-btn" class="btn btn-primary w-100">
                                    <i class="bi bi-search"></i> Find CONUS Analogs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading/Error States -->
                <div id="conus-analog-loading" class="text-center py-5" style="display: none;">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Computing CONUS analog patterns (this may take 20-30 seconds)...</p>
                </div>
                <div id="conus-analog-error" class="alert alert-danger" style="display: none;"></div>

                <!-- Summary Stats -->
                <div class="row mb-3" id="conus-summary-stats" style="display:none;">
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted mb-1">CONUS Avg Anomaly</h6>
                                <h4 id="conus-avg-anomaly" class="mb-0">--</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted mb-1">Above Normal</h6>
                                <h4 id="conus-pct-above" class="mb-0">--</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted mb-1">Below Normal</h6>
                                <h4 id="conus-pct-below" class="mb-0">--</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="text-muted mb-1">Current Wave #</h6>
                                <h4 id="conus-wave-number" class="mb-0">--</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Heatmap Container -->
                <div class="card mb-4" id="conus-heatmap-card" style="display:none;">
                    <div class="card-header">
                        <i class="bi bi-map"></i> <span id="conus-heatmap-title">14-Day Precipitation Analog</span>
                    </div>
                    <div class="card-body">
                        <div id="conus-analog-heatmap" style="height: 600px;"></div>
                    </div>
                </div>

                <!-- Analog Date Table -->
                <div class="card" id="conus-analog-table-card" style="display:none;">
                    <div class="card-header">
                        <i class="bi bi-calendar-check"></i> Analog Dates
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm" id="conus-analog-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Date</th>
                                        <th>Correlation</th>
                                        <th>Days Ago</th>
                                    </tr>
                                </thead>
                                <tbody id="conus-analog-table-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div><!-- End CONUS Analogs subtab -->
        </div><!-- End ERA subtab content -->
    </div><!-- End ERA Reanalysis tab -->
</div><!-- End tab-content -->
{% endblock %}

{% block extra_js %}
<script>
let tempChart, anomalyChart, rainChart, soilTempChart, soilMoistureChart, solarChart, windChart;

Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif";
Chart.defaults.color = '#555';

function initCharts() {
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'top',
            }
        },
        scales: {
            x: {
                grid: { display: false }
            },
            y: {
                grid: { color: '#eee' }
            }
        }
    };

    tempChart = new Chart(document.getElementById('tempChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'High Normal Range',
                    data: [],
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(255, 99, 71, 0.15)',
                    fill: '+1',
                    tension: 0.4,
                    pointRadius: 0,
                    order: 10
                },
                {
                    label: 'High 25th %ile',
                    data: [],
                    borderColor: 'transparent',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    order: 10
                },
                {
                    label: 'Low Normal Range',
                    data: [],
                    borderColor: 'transparent',
                    backgroundColor: 'rgba(70, 130, 180, 0.15)',
                    fill: '+1',
                    tension: 0.4,
                    pointRadius: 0,
                    order: 10
                },
                {
                    label: 'Low 25th %ile',
                    data: [],
                    borderColor: 'transparent',
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    order: 10
                },
                {
                    label: 'Normal High',
                    data: [],
                    borderColor: 'rgba(220, 53, 69, 0.6)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    order: 5
                },
                {
                    label: 'Normal Low',
                    data: [],
                    borderColor: 'rgba(0, 123, 255, 0.6)',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    order: 5
                },
                {
                    label: 'Observed High',
                    data: [],
                    borderColor: '#dc3545',
                    backgroundColor: '#dc3545',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    order: 1
                },
                {
                    label: 'Observed Low',
                    data: [],
                    borderColor: '#007bff',
                    backgroundColor: '#007bff',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.1,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    order: 1
                },
                {
                    label: '95th %ile High',
                    data: [],
                    borderColor: 'rgba(255, 99, 71, 0.3)',
                    borderWidth: 1,
                    borderDash: [2, 2],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    order: 8
                },
                {
                    label: '5th %ile Low',
                    data: [],
                    borderColor: 'rgba(70, 130, 180, 0.3)',
                    borderWidth: 1,
                    borderDash: [2, 2],
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    order: 8
                }
            ]
        },
        options: {
            ...commonOptions,
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        filter: function(item, chart) {
                            return !item.text.includes('25th %ile');
                        }
                    }
                }
            },
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'Temperature (deg F)' } }
            }
        }
    });

    anomalyChart = new Chart(document.getElementById('anomalyChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [
                {
                    label: 'Daily Anomaly',
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1
                },
                {
                    label: 'Running Mean',
                    data: [],
                    type: 'line',
                    borderColor: '#333',
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3,
                    pointRadius: 0,
                    order: 0
                }
            ]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: {
                    ...commonOptions.scales.y,
                    title: { display: true, text: 'Anomaly (deg F)' },
                    suggestedMin: -20,
                    suggestedMax: 20
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                },
                annotation: {
                    annotations: {
                        zeroLine: {
                            type: 'line',
                            yMin: 0,
                            yMax: 0,
                            borderColor: 'rgba(0, 0, 0, 0.3)',
                            borderWidth: 1,
                            borderDash: [5, 5]
                        }
                    }
                }
            }
        }
    });

    rainChart = new Chart(document.getElementById('rainChart'), {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Daily Rain',
                data: [],
                backgroundColor: '#1976d2',
                borderRadius: 4
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'Rainfall (in)' }, beginAtZero: true }
            }
        }
    });

    soilTempChart = new Chart(document.getElementById('soilTempChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: '5" Deep',
                    data: [],
                    borderColor: '#8d6e63',
                    fill: false,
                    tension: 0.3
                },
                {
                    label: '10" Deep',
                    data: [],
                    borderColor: '#6d4c41',
                    fill: false,
                    tension: 0.3
                },
                {
                    label: '20" Deep',
                    data: [],
                    borderColor: '#4e342e',
                    fill: false,
                    tension: 0.3
                }
            ]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'Temperature (deg F)' } }
            }
        }
    });

    soilMoistureChart = new Chart(document.getElementById('soilMoistureChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                {
                    label: '5" Deep',
                    data: [],
                    borderColor: '#2196f3',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3
                },
                {
                    label: '10" Deep',
                    data: [],
                    borderColor: '#1976d2',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3
                },
                {
                    label: '20" Deep',
                    data: [],
                    borderColor: '#0d47a1',
                    borderWidth: 2,
                    fill: false,
                    tension: 0.3
                }
            ]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: {
                    ...commonOptions.scales.y,
                    title: { display: true, text: 'Soil Moisture (cb)' },
                    beginAtZero: true,
                    max: 80
                }
            },
            plugins: {
                ...commonOptions.plugins,
                annotation: {
                    annotations: {
                        saturatedZone: {
                            type: 'box',
                            yMin: 0,
                            yMax: 10,
                            backgroundColor: 'rgba(25, 118, 210, 0.15)',
                            borderWidth: 0,
                            label: {
                                display: true,
                                content: 'Saturated',
                                position: 'start',
                                font: { size: 10 },
                                color: '#1976d2'
                            }
                        },
                        adequateZone: {
                            type: 'box',
                            yMin: 10,
                            yMax: 30,
                            backgroundColor: 'rgba(76, 175, 80, 0.15)',
                            borderWidth: 0,
                            label: {
                                display: true,
                                content: 'Adequate',
                                position: 'start',
                                font: { size: 10 },
                                color: '#4caf50'
                            }
                        },
                        dryZone: {
                            type: 'box',
                            yMin: 30,
                            yMax: 60,
                            backgroundColor: 'rgba(255, 152, 0, 0.15)',
                            borderWidth: 0,
                            label: {
                                display: true,
                                content: 'Needs Water',
                                position: 'start',
                                font: { size: 10 },
                                color: '#ff9800'
                            }
                        },
                        veryDryZone: {
                            type: 'box',
                            yMin: 60,
                            yMax: 80,
                            backgroundColor: 'rgba(244, 67, 54, 0.15)',
                            borderWidth: 0,
                            label: {
                                display: true,
                                content: 'Very Dry',
                                position: 'start',
                                font: { size: 10 },
                                color: '#f44336'
                            }
                        }
                    }
                }
            }
        }
    });

    solarChart = new Chart(document.getElementById('solarChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Avg Solar Rad',
                data: [],
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.2)',
                fill: true,
                tension: 0.3
            },
            {
                label: 'Max Solar Rad',
                data: [],
                borderColor: '#ff9800',
                borderDash: [5, 5],
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'W/m2' }, beginAtZero: true }
            }
        }
    });

    windChart = new Chart(document.getElementById('windChart'), {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Avg Gust',
                data: [],
                borderColor: '#607d8b',
                fill: false,
                tension: 0.3
            },
            {
                label: 'Max Gust',
                data: [],
                borderColor: '#455a64',
                borderDash: [5, 5],
                fill: false,
                tension: 0.3
            }]
        },
        options: {
            ...commonOptions,
            scales: {
                ...commonOptions.scales,
                y: { ...commonOptions.scales.y, title: { display: true, text: 'Wind Speed (mph)' }, beginAtZero: true }
            }
        }
    });
}

function updateCharts(data) {
    const daily = data.daily || [];
    const climo = data.climo || [];
    const anomalies = data.anomalies || [];

    const labels = daily.map(d => {
        const date = new Date(d.date);
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    });

    tempChart.data.labels = labels;

    tempChart.data.datasets[0].data = climo.map(c => c.high_p75);
    tempChart.data.datasets[1].data = climo.map(c => c.high_p25);
    tempChart.data.datasets[2].data = climo.map(c => c.low_p75);
    tempChart.data.datasets[3].data = climo.map(c => c.low_p25);
    tempChart.data.datasets[4].data = climo.map(c => c.high_median);
    tempChart.data.datasets[5].data = climo.map(c => c.low_median);
    tempChart.data.datasets[6].data = daily.map(d => d.temp_high);
    tempChart.data.datasets[7].data = daily.map(d => d.temp_low);
    tempChart.data.datasets[8].data = climo.map(c => c.high_p95);
    tempChart.data.datasets[9].data = climo.map(c => c.low_p05);

    tempChart.update();

    anomalyChart.data.labels = labels;

    const anomalyValues = anomalies.map(a => a.anomaly);
    const anomalyColors = anomalyValues.map(v => {
        if (v === null) return 'rgba(128, 128, 128, 0.5)';
        return v >= 0 ? 'rgba(220, 53, 69, 0.7)' : 'rgba(0, 123, 255, 0.7)';
    });
    const anomalyBorders = anomalyValues.map(v => {
        if (v === null) return 'rgba(128, 128, 128, 0.8)';
        return v >= 0 ? 'rgba(220, 53, 69, 1)' : 'rgba(0, 123, 255, 1)';
    });

    anomalyChart.data.datasets[0].data = anomalyValues;
    anomalyChart.data.datasets[0].backgroundColor = anomalyColors;
    anomalyChart.data.datasets[0].borderColor = anomalyBorders;

    anomalyChart.data.datasets[1].data = anomalies.map(a => a.running_mean);

    anomalyChart.update();

    rainChart.data.labels = labels;
    rainChart.data.datasets[0].data = daily.map(d => d.rain_total);
    rainChart.update();

    soilTempChart.data.labels = labels;
    soilTempChart.data.datasets[0].data = daily.map(d => d.soil_temp_5in_avg);
    soilTempChart.data.datasets[1].data = daily.map(d => d.soil_temp_10in_avg);
    soilTempChart.data.datasets[2].data = daily.map(d => d.soil_temp_20in_avg);
    soilTempChart.update();

    soilMoistureChart.data.labels = labels;
    soilMoistureChart.data.datasets[0].data = daily.map(d => d.soil_moisture_5in_avg);
    soilMoistureChart.data.datasets[1].data = daily.map(d => d.soil_moisture_10in_avg);
    soilMoistureChart.data.datasets[2].data = daily.map(d => d.soil_moisture_20in_avg);
    soilMoistureChart.update();

    solarChart.data.labels = labels;
    solarChart.data.datasets[0].data = daily.map(d => d.solar_rad_avg);
    solarChart.data.datasets[1].data = daily.map(d => d.solar_rad_max);
    solarChart.update();

    windChart.data.labels = labels;
    windChart.data.datasets[0].data = daily.map(d => d.wind_gust_avg);
    windChart.data.datasets[1].data = daily.map(d => d.wind_gust_max);
    windChart.update();
}

function updateSummary(summary) {
    const fmt = (val, decimals = 1) => val !== null && val !== undefined ? Number(val).toFixed(decimals) : '--';
    const fmtInt = (val) => val !== null && val !== undefined ? Math.round(val) : '--';

    document.getElementById('temp-min').textContent = fmt(summary.temp_min);
    document.getElementById('temp-max').textContent = fmt(summary.temp_max);
    document.getElementById('temp-avg').textContent = fmt(summary.temp_avg);
    document.getElementById('rain-total').innerHTML = fmt(summary.rain_total, 2) + '<span class="stat-unit"> in</span>';
    document.getElementById('rainy-days').textContent = summary.rainy_days || 0;
    document.getElementById('solar-avg').innerHTML = fmtInt(summary.solar_rad_avg) + '<span class="stat-unit"> W/m2</span>';
    document.getElementById('solar-historical').textContent = fmtInt(summary.solar_rad_historical);
    document.getElementById('wind-avg').innerHTML = fmt(summary.wind_gust_avg) + '<span class="stat-unit"> / </span><span id="wind-gust-max">' + fmt(summary.wind_gust_max) + '</span><span class="stat-unit"> mph</span>';
    document.getElementById('wind-gust-historical').textContent = fmt(summary.wind_gust_historical);
    document.getElementById('days-count').textContent = summary.days || 0;
}

function loadData() {
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }

    fetch(`/api/historical?start=${startDate}&end=${endDate}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
                return;
            }
            updateCharts(data);
            updateSummary(data.summary || {});

            const url = new URL(window.location);
            url.searchParams.set('start', startDate);
            url.searchParams.set('end', endDate);
            window.history.pushState({}, '', url);
        })
        .catch(error => {
            console.error('Error loading data:', error);
            alert('Error loading weather data');
        });
}

function setDateRange(days) {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);

    document.getElementById('start-date').value = start.toISOString().split('T')[0];
    document.getElementById('end-date').value = end.toISOString().split('T')[0];
    loadData();
}

function setYTD() {
    const end = new Date();
    const start = new Date(end.getFullYear(), 0, 1);

    document.getElementById('start-date').value = start.toISOString().split('T')[0];
    document.getElementById('end-date').value = end.toISOString().split('T')[0];
    loadData();
}

// ERA5 Reanalysis functions
let eraWaveChart;

// Calculate running mean with specified window size
function calculateRunningMean(data, windowSize) {
    if (!data || data.length === 0) return [];

    const result = [];
    const halfWindow = Math.floor(windowSize / 2);

    for (let i = 0; i < data.length; i++) {
        // Skip null values
        if (data[i] === null || data[i] === undefined) {
            result.push(null);
            continue;
        }

        // Determine window bounds
        const start = Math.max(0, i - halfWindow);
        const end = Math.min(data.length - 1, i + halfWindow);

        // Calculate mean of non-null values in window
        let sum = 0;
        let count = 0;
        for (let j = start; j <= end; j++) {
            if (data[j] !== null && data[j] !== undefined) {
                sum += data[j];
                count++;
            }
        }

        result.push(count > 0 ? sum / count : null);
    }

    return result;
}

function initEraCharts() {
    // Initialize ERA5 wave chart
    const ctx = document.getElementById('eraWaveChart');
    if (ctx) {
        eraWaveChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Wave Number',
                        data: [],
                        backgroundColor: 'rgba(0, 136, 204, 0.7)',
                        borderColor: '#0088cc',
                        borderWidth: 1
                    },
                    {
                        label: '7-Day Running Mean',
                        data: [],
                        type: 'line',
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        order: 0
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const point = context.parsed;
                                return `Wave Number: ${point.y.toFixed(1)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        title: { display: true, text: 'Date' }
                    },
                    y: {
                        grid: { color: '#eee' },
                        title: { display: true, text: 'Wave Number' },
                        suggestedMin: 0,
                        suggestedMax: 10
                    }
                }
            }
        });
    }
}

function setEraDateRange(days) {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - days);

    document.getElementById('era-start-date').value = start.toISOString().split('T')[0];
    document.getElementById('era-end-date').value = end.toISOString().split('T')[0];
}

function loadEraData() {
    const startDate = document.getElementById('era-start-date').value;
    const endDate = document.getElementById('era-end-date').value;

    if (!startDate || !endDate) {
        alert('Please select both start and end dates');
        return;
    }

    document.getElementById('era-wave-loading').style.display = 'block';
    document.getElementById('era-wave-error').style.display = 'none';

    fetch(`/api/era5/wave-analysis?start_date=${startDate}&end_date=${endDate}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('era-wave-loading').style.display = 'none';

            if (!data.success) {
                document.getElementById('era-wave-error').textContent = data.error;
                document.getElementById('era-wave-error').style.display = 'block';
                return;
            }

            // Update wave chart
            const labels = data.wave_data.map(d => new Date(d.time).toLocaleDateString());
            const waveNumbers = data.wave_data.map(d => d.wave_number);
            const runningMean = calculateRunningMean(waveNumbers, 7);

            eraWaveChart.data.labels = labels;
            eraWaveChart.data.datasets[0].data = waveNumbers;
            eraWaveChart.data.datasets[1].data = runningMean;
            eraWaveChart.update();
        })
        .catch(error => {
            document.getElementById('era-wave-loading').style.display = 'none';
            document.getElementById('era-wave-error').textContent = 'Error loading ERA5 data: ' + error;
            document.getElementById('era-wave-error').style.display = 'block';
        });
}

let mapLoadInProgress = false;

function loadAnalogs() {
    const count  = document.getElementById('analog-count').value;
    const method = document.getElementById('analog-method')?.value || 'composite';

    document.getElementById('analog-loading').style.display = 'block';
    document.getElementById('analog-error').style.display = 'none';
    document.getElementById('analog-results').style.display = 'none';

    fetch(`/api/era5/analogs?top_n=${count}&method=${method}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.text();
        })
        .then(text => {
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                console.error('Failed to parse JSON:', text);
                throw new Error('Server returned invalid JSON. Check Flask logs for errors.');
            }
            return data;
        })
        .then(data => {
            document.getElementById('analog-loading').style.display = 'none';

            if (!data.success) {
                document.getElementById('analog-error').textContent = data.error;
                document.getElementById('analog-error').style.display = 'block';
                return;
            }

            // Update current date and wave number
            const currentDate = new Date(data.current_date);
            const waveText = `${currentDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', timeZoneName: 'short' })} (Wave ${data.current_wave_number})`;
            document.getElementById('analog-current-date').textContent = waveText;

            // Update average precipitation
            const avgPrecip = data.avg_precip_14d;
            const climPrecip = data.climatology_precip_14d;

            if (avgPrecip !== null && avgPrecip !== undefined) {
                document.getElementById('analog-avg-precip').textContent = `${avgPrecip}"`;
            } else {
                document.getElementById('analog-avg-precip').textContent = 'N/A';
            }

            // Update climatology precipitation
            if (climPrecip !== null && climPrecip !== undefined) {
                document.getElementById('analog-climatology-precip').textContent = `${climPrecip}"`;
            } else {
                document.getElementById('analog-climatology-precip').textContent = 'N/A';
            }

            // Update average temperature
            const avgTemp = data.avg_temp_14d;
            const climTemp = data.climatology_temp_14d;

            if (avgTemp !== null && avgTemp !== undefined) {
                document.getElementById('analog-avg-temp').textContent = `${avgTemp.toFixed(1)}°F`;
            } else {
                document.getElementById('analog-avg-temp').textContent = 'N/A';
            }

            // Update climatology temperature
            if (climTemp !== null && climTemp !== undefined) {
                document.getElementById('analog-climatology-temp').textContent = `${climTemp.toFixed(1)}°F`;
            } else {
                document.getElementById('analog-climatology-temp').textContent = 'N/A';
            }

            // Show precipitation comparison
            if (avgPrecip !== null && climPrecip !== null) {
                const diff = avgPrecip - climPrecip;
                const pctDiff = ((diff / climPrecip) * 100).toFixed(0);
                const comparisonDiv = document.getElementById('analog-precip-comparison');
                const comparisonText = document.getElementById('analog-precip-comparison-text');

                comparisonDiv.className = 'alert alert-success';
                if (diff > 0.1) {
                    comparisonText.textContent = `Analogs show ${diff.toFixed(2)}" more than normal (${pctDiff > 0 ? '+' : ''}${pctDiff}% above average)`;
                } else if (diff < -0.1) {
                    comparisonText.textContent = `Analogs show ${Math.abs(diff).toFixed(2)}" less than normal (${pctDiff}% below average)`;
                } else {
                    comparisonText.textContent = `Analogs show near-normal precipitation`;
                }
                comparisonDiv.style.display = 'block';
            } else {
                document.getElementById('analog-precip-comparison').style.display = 'none';
            }

            // Show temperature comparison
            if (avgTemp !== null && climTemp !== null) {
                const diff = avgTemp - climTemp;
                const pctDiff = climTemp !== 0 ? ((diff / Math.abs(climTemp)) * 100).toFixed(0) : 0;
                const comparisonDiv = document.getElementById('analog-temp-comparison');
                const comparisonText = document.getElementById('analog-temp-comparison-text');

                comparisonDiv.className = 'alert alert-warning';
                if (diff > 1) {
                    comparisonText.textContent = `Analogs show ${diff.toFixed(1)}°F warmer than normal (${pctDiff > 0 ? '+' : ''}${pctDiff}% above average)`;
                } else if (diff < -1) {
                    comparisonText.textContent = `Analogs show ${Math.abs(diff).toFixed(1)}°F cooler than normal (${pctDiff}% below average)`;
                } else {
                    comparisonText.textContent = `Analogs show near-normal temperatures`;
                }
                comparisonDiv.style.display = 'block';
            } else {
                document.getElementById('analog-temp-comparison').style.display = 'none';
            }

            // Populate table
            const tbody = document.getElementById('analog-table-body');
            tbody.innerHTML = '';

            data.analogs.forEach((analog, index) => {
                const analogDate = new Date(analog.date);
                const daysAgo = Math.round((currentDate - analogDate) / (1000 * 60 * 60 * 24));
                const precipText = analog.precip_14d !== null && analog.precip_14d !== undefined
                    ? `${analog.precip_14d}"`
                    : 'N/A';
                const tempText = analog.temp_14d !== null && analog.temp_14d !== undefined
                    ? `${analog.temp_14d.toFixed(1)}°F`
                    : 'N/A';

                // Primary score badge
                const score = analog.composite_score != null
                    ? analog.composite_score
                    : analog.correlation;
                const scorePct = (score * 100).toFixed(1);
                const scoreColor = score >= 0.7 ? 'bg-success' : score >= 0.55 ? 'bg-warning text-dark' : 'bg-secondary';

                // Sub-scores (Pattern = lat_pearson via correlation field, Circulation = grad_corr)
                const patternStr = analog.correlation != null
                    ? `<small class="text-muted">${(analog.correlation * 100).toFixed(1)}%</small>`
                    : '<small class="text-muted">—</small>';
                const circStr = analog.grad_corr != null
                    ? `<small class="text-muted">${(analog.grad_corr * 100).toFixed(1)}%</small>`
                    : '<small class="text-muted">—</small>';

                // Date string for compare endpoint (YYYY-MM-DD)
                const analogDateStr = analogDate.toISOString().split('T')[0];

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <a href="#" class="fw-semibold text-decoration-none analog-date-link"
                           onclick="loadAnalogCompare('${analogDateStr}'); return false;"
                           title="Click to compare 500mb pattern vs current GFS">
                            ${analogDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' })}
                            <i class="bi bi-map ms-1 text-muted" style="font-size:0.75rem;"></i>
                        </a>
                    </td>
                    <td><span class="badge ${scoreColor}">${scorePct}%</span></td>
                    <td>${patternStr}</td>
                    <td>${circStr}</td>
                    <td>${analog.wave_number || 'N/A'}</td>
                    <td>${precipText}</td>
                    <td>${tempText}</td>
                    <td>${daysAgo > 0 ? daysAgo + ' days ago' : 'Today'}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('analog-results').style.display = 'block';

            // Reload the history chart to include the new prediction
            loadAnalogHistory();
        })
        .catch(error => {
            document.getElementById('analog-loading').style.display = 'none';
            document.getElementById('analog-error').textContent = 'Error loading analogs: ' + error;
            document.getElementById('analog-error').style.display = 'block';
        });
}

function loadHeightMap() {
    const date = document.getElementById('map-date-select').value;

    if (!date) {
        return;
    }

    // Prevent multiple simultaneous requests
    if (mapLoadInProgress) {
        return;
    }

    mapLoadInProgress = true;
    const container = document.getElementById('height-map-container');
    document.getElementById('height-map-loading').style.display = 'block';
    container.innerHTML = '';

    fetch(`/api/era5/500mb-map?date=${date}`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('height-map-loading').style.display = 'none';
            mapLoadInProgress = false;

            if (!data.success) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> ${data.error}
                    </div>`;
                return;
            }

            // Display map image
            container.innerHTML = `<img src="${data.map_image}" alt="500mb Height Map" style="max-width: 100%; height: auto; border-radius: 8px;">`;

            // Update info display
            document.getElementById('map-date-display').textContent = new Date(data.date).toLocaleDateString();
            const dominantWaves = data.dominant_waves || [];
            const topWavesText = dominantWaves.length > 0 ? dominantWaves.slice(0, 3).join(', ') : 'N/A';
            document.getElementById('map-wave-info').innerHTML =
                `Dominant Wave Number: <strong>${data.wave_number}</strong> | ` +
                `Top 3 Waves: <strong>${topWavesText}</strong>`;
        })
        .catch(error => {
            document.getElementById('height-map-loading').style.display = 'none';
            mapLoadInProgress = false;
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-x-circle"></i> Error: ${error}
                </div>`;
        });
}

function navigateMapDate(direction) {
    const dateInput = document.getElementById('map-date-select');
    let currentDate = new Date(dateInput.value);

    // Handle invalid date
    if (isNaN(currentDate.getTime())) {
        currentDate = new Date();
    }

    switch(direction) {
        case 'first':
            // Go to first available date (start of ERA5 data: 2021-01-01)
            currentDate = new Date('2021-01-01');
            break;
        case 'prev':
            // Go back one day
            currentDate.setDate(currentDate.getDate() - 1);
            break;
        case 'next':
            // Go forward one day
            currentDate.setDate(currentDate.getDate() + 1);
            break;
        case 'last':
            // Go to most recent date
            currentDate = new Date();
            break;
    }

    // Update input and load map
    dateInput.value = currentDate.toISOString().split('T')[0];
    loadHeightMap();
}

// Analog history chart
let analogHistoryChart = null;

function loadAnalogHistory() {
    fetch('/api/era5/analog-history')
        .then(response => response.json())
        .then(data => {
            if (!data.success || !data.predictions || data.predictions.length === 0) {
                console.log('No analog history data available');
                return;
            }

            const predictions = data.predictions;

            // Extract data for chart
            const dates = predictions.map(p => {
                const date = new Date(p.prediction_date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const precipValues = predictions.map(p => p.analog_precip);
            const precipNormals = predictions.map(p => p.climatology_precip);
            const tempValues = predictions.map(p => p.analog_temp);
            const tempNormals = predictions.map(p => p.climatology_temp);
            const correlations = predictions.map(p => p.avg_correlation || 0);

            // Create chart
            const ctx = document.getElementById('analogHistoryChart').getContext('2d');

            if (analogHistoryChart) {
                analogHistoryChart.destroy();
            }

            analogHistoryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Analog Precip (14-day)',
                            data: precipValues,
                            borderColor: '#22c55e',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y-precip'
                        },
                        {
                            label: 'Normal Precip',
                            data: precipNormals,
                            borderColor: '#86efac',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y-precip'
                        },
                        {
                            label: 'Analog Temp (14-day avg)',
                            data: tempValues,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            tension: 0.3,
                            fill: true,
                            yAxisID: 'y-temp'
                        },
                        {
                            label: 'Normal Temp',
                            data: tempNormals,
                            borderColor: '#fde68a',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            tension: 0.3,
                            fill: false,
                            yAxisID: 'y-temp'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.dataset.yAxisID === 'y-precip') {
                                        label += context.parsed.y.toFixed(2) + '"';
                                    } else {
                                        label += context.parsed.y.toFixed(1) + '°F';
                                    }
                                    return label;
                                },
                                afterBody: function(tooltipItems) {
                                    if (tooltipItems.length > 0) {
                                        const index = tooltipItems[0].dataIndex;
                                        const correlation = correlations[index];
                                        const percentage = (correlation * 100).toFixed(1);
                                        return '\nPattern Similarity: ' + percentage + '%';
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        'y-precip': {
                            type: 'linear',
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Precipitation (inches)'
                            },
                            grid: {
                                color: '#e0e0e0'
                            }
                        },
                        'y-temp': {
                            type: 'linear',
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Temperature (°F)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        })
        .catch(error => {
            console.error('Error loading analog history:', error);
        });
}

// ========== Analog Pattern Comparison ==========

function loadAnalogCompare(dateStr) {
    const card    = document.getElementById('analog-compare-card');
    const loading = document.getElementById('analog-compare-loading');
    const errDiv  = document.getElementById('analog-compare-error');
    const imgWrap = document.getElementById('analog-compare-img-wrap');
    const img     = document.getElementById('analog-compare-img');
    const caption = document.getElementById('analog-compare-caption');
    const title   = document.getElementById('analog-compare-title');

    // Show card in loading state
    card.style.display = 'block';
    loading.style.display = 'block';
    errDiv.style.display  = 'none';
    imgWrap.style.display = 'none';
    title.textContent = dateStr + ' vs current GFS';

    // Scroll the card into view
    card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

    fetch(`/api/era5/analog-compare-map?date=${dateStr}`)
        .then(r => r.json())
        .then(data => {
            loading.style.display = 'none';
            if (!data.success) {
                errDiv.textContent = data.error || 'Unknown error';
                errDiv.style.display = 'block';
                return;
            }
            img.src = data.map_image;
            title.textContent = `${data.analog_date} (Wave #${data.analog_wave ?? '?'}) vs ${data.gfs_init} (Wave #${data.current_wave ?? '?'})`;
            caption.textContent = 'Left: ERA5 historical pattern  |  Right: Current GFS pattern  |  Shading = anomaly vs 1990–2021 climatology';
            imgWrap.style.display = 'block';
        })
        .catch(err => {
            loading.style.display = 'none';
            errDiv.textContent = 'Error loading comparison: ' + err;
            errDiv.style.display = 'block';
        });
}

function closeAnalogCompare() {
    document.getElementById('analog-compare-card').style.display = 'none';
}

// ========== CONUS Analog Functions ==========

async function loadConusAnalogs() {
    const topN = document.getElementById('conus-analog-count').value;
    const variable = document.getElementById('conus-analog-variable').value;

    // Show loading spinner
    document.getElementById('conus-analog-loading').style.display = 'block';
    document.getElementById('conus-analog-error').style.display = 'none';
    document.getElementById('conus-summary-stats').style.display = 'none';
    document.getElementById('conus-heatmap-card').style.display = 'none';
    document.getElementById('conus-analog-table-card').style.display = 'none';

    try {
        const response = await fetch(`/api/era5/analogs-conus?top_n=${topN}&variable=${variable}`);
        const data = await response.json();

        document.getElementById('conus-analog-loading').style.display = 'none';

        if (!data.success) {
            document.getElementById('conus-analog-error').textContent = data.error || 'Unknown error occurred';
            document.getElementById('conus-analog-error').style.display = 'block';
            return;
        }

        // Update summary stats
        updateConusSummaryStats(data, variable);

        // Render heatmap
        renderConusHeatmap(data, variable);

        // Update analog table
        updateConusAnalogTable(data);

        // Show all sections
        document.getElementById('conus-summary-stats').style.display = 'flex';
        document.getElementById('conus-heatmap-card').style.display = 'block';
        document.getElementById('conus-analog-table-card').style.display = 'block';

    } catch (error) {
        document.getElementById('conus-analog-loading').style.display = 'none';
        document.getElementById('conus-analog-error').textContent = 'Error loading CONUS analogs: ' + error;
        document.getElementById('conus-analog-error').style.display = 'block';
        console.error('Error:', error);
    }
}

function updateConusSummaryStats(data, variable) {
    const varData = variable === 'precip' ? data.precip : data.temp;

    if (!varData) {
        console.warn('No data for variable:', variable);
        return;
    }

    // Flatten the grid to calculate statistics (use US units)
    const flatData = varData.anomaly_in ? varData.anomaly_in.flat() : varData.anomaly_f.flat();
    const flatPercent = varData.anomaly_percent.flat();

    // Filter out NaN values
    const validData = flatData.filter(val => isFinite(val));
    const validPercent = flatPercent.filter(val => isFinite(val));

    // Calculate mean anomaly
    const meanAnomaly = validData.reduce((sum, val) => sum + val, 0) / validData.length;

    // Calculate percent above/below normal
    const aboveNormal = validPercent.filter(val => val > 5).length;
    const belowNormal = validPercent.filter(val => val < -5).length;
    const pctAbove = (aboveNormal / validPercent.length * 100).toFixed(1);
    const pctBelow = (belowNormal / validPercent.length * 100).toFixed(1);

    // Update DOM with US units
    if (variable === 'precip') {
        document.getElementById('conus-avg-anomaly').textContent = `${meanAnomaly.toFixed(2)}"`;
        document.getElementById('conus-pct-above').textContent = `${pctAbove}% wetter`;
        document.getElementById('conus-pct-below').textContent = `${pctBelow}% drier`;
    } else {
        document.getElementById('conus-avg-anomaly').textContent = `${meanAnomaly.toFixed(1)}°F`;
        document.getElementById('conus-pct-above').textContent = `${pctAbove}% warmer`;
        document.getElementById('conus-pct-below').textContent = `${pctBelow}% cooler`;
    }

    document.getElementById('conus-wave-number').textContent = data.current_wave_number || 'N/A';
}

function renderConusHeatmap(data, variable) {
    const varData = variable === 'precip' ? data.precip : data.temp;

    if (!varData) {
        console.warn('No data for variable:', variable);
        return;
    }

    const zData = varData.anomaly_percent;
    const units = variable === 'precip' ? 'inches' : '°F';
    const title = variable === 'precip' ? '14-Day Precipitation Analog' : '14-Day Temperature Analog';

    // Update card title
    document.getElementById('conus-heatmap-title').textContent = title;

    // Create Plotly heatmap
    const trace = {
        type: 'heatmap',
        x: data.grid.longitudes,
        y: data.grid.latitudes,
        z: zData,
        colorscale: variable === 'precip' ? [
            [0.0, '#8B4513'],  // Brown (very dry)
            [0.3, '#F4A460'],  // Sandy brown (dry)
            [0.5, '#FFFFFF'],  // White (normal)
            [0.7, '#90EE90'],  // Light green (wet)
            [1.0, '#006400']   // Dark green (very wet)
        ] : [
            [0.0, '#0000FF'],  // Blue (cold)
            [0.3, '#87CEEB'],  // Sky blue (cool)
            [0.5, '#FFFFFF'],  // White (normal)
            [0.7, '#FFA500'],  // Orange (warm)
            [1.0, '#FF0000']   // Red (hot)
        ],
        zmid: 0,
        zmin: -100,
        zmax: 100,
        colorbar: {
            title: 'Anomaly (%)',
            len: 0.8
        },
        hovertemplate:
            'Lat: %{y:.2f}°<br>' +
            'Lon: %{x:.2f}°<br>' +
            'Anomaly: %{z:.1f}%<br>' +
            '<extra></extra>'
    };

    const layout = {
        title: `${title} - Percent Anomaly from 1990-2020 Normal`,
        xaxis: {
            title: 'Longitude',
            range: [-125, -66]
        },
        yaxis: {
            title: 'Latitude',
            range: [24, 49]
        },
        height: 600,
        margin: { l: 50, r: 50, t: 80, b: 50 }
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false
    };

    Plotly.newPlot('conus-analog-heatmap', [trace], layout, config);
}

function updateConusAnalogTable(data) {
    const tbody = document.getElementById('conus-analog-table-body');
    tbody.innerHTML = '';

    const currentDate = new Date(data.current_date);
    // analog_correlations is a list of {date, correlation, composite_score}
    const corrMap = {};
    (data.analog_correlations || []).forEach(item => { corrMap[item.date] = item; });

    data.analog_dates.forEach((dateStr, index) => {
        const analogDate = new Date(dateStr);
        const daysAgo = Math.floor((currentDate - analogDate) / (1000 * 60 * 60 * 24));

        const item = corrMap[dateStr] || {};
        const score = item.composite_score != null ? item.composite_score : item.correlation;
        const scoreCell = score != null
            ? `<span class="badge bg-success">${(score * 100).toFixed(1)}%</span>`
            : '--';

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${analogDate.toLocaleDateString()}</td>
            <td>${scoreCell}</td>
            <td>${daysAgo} days</td>
        `;
        tbody.appendChild(row);
    });
}

// Event listeners for CONUS Analogs
document.getElementById('load-conus-analogs-btn')?.addEventListener('click', loadConusAnalogs);
document.getElementById('conus-analog-variable')?.addEventListener('change', function() {
    // Re-render if data already loaded
    if (document.getElementById('conus-heatmap-card').style.display !== 'none') {
        loadConusAnalogs();
    }
});

// ========== End CONUS Analog Functions ==========

document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    loadData();
    initEraCharts();
    loadAnalogHistory();  // Load analog prediction history chart

    // Set default ERA5 dates (last 30 days)
    setEraDateRange(30);

    // Set default map date (today)
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('map-date-select').value = today;

});
</script>
{% endblock %}
